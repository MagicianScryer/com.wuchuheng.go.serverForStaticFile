!function(){"use strict";var r=function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")},t=function(t,e,r){return e&&n(t.prototype,e),r&&n(t,r),t};function n(t,e){for(var r=0;r<e.length;r++){var n=e[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}var i=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e};function p(){return!!ht.hasOwnProperty("mapbox")}var J=(t(e,[{key:"getXY",value:function(t,e,r){if(p()){"bd"===r?t=this.bd09towgs84(t[0],t[1]):"gd"===r&&(t=this.gcj02towgs84(t[0],t[1]));r=this.projectToHT(t),t=this.projectToHT(e),e=this.getGroundResolution(e[1]);return{x:(r.x-t.x)/e,y:-(r.y-t.y)/e}}}},{key:"getLngLat",value:function(t,e){if(p()){var r=this.projectToHT(e),n=this.getGroundResolution(e[1]),e={};return e.x=t.x*n+r.x,e.y=-t.y*n+r.y,this.projectToGis(e)}}},{key:"projectToHT",value:function(t){var e=this._pixelSize/(this._worldRadius*Math.PI)/2;return{x:this._worldRadius*t[0]*Math.PI/180*e,y:this._worldRadius*Math.log(Math.tan(.25*Math.PI+.5*t[1]*Math.PI/180))*e}}},{key:"getGroundResolution",value:function(t){var e=2*this._worldRadius*Math.PI;return Math.abs(this._pixelSize*(1/Math.cos(t*Math.PI/180))/e)}},{key:"projectToGis",value:function(t){var e=this._pixelSize/(this._worldRadius*Math.PI)/2;return[t.x/(this._worldRadius*Math.PI/180*e),-2*(Math.atan(Math.exp(t.y/(e*-this._worldRadius)))-Math.PI/4)/(Math.PI/180)]}},{key:"wgs84togcj02",value:function(t,e){var r=.006693421622965943;if(this.out_of_china(t,e))return[t,e];var n=this.transformlat(t-105,e-35),i=this.transformlng(t-105,e-35),o=e/180*Math.PI,a=1-r*(a=Math.sin(o))*a,s=Math.sqrt(a),n=180*n/(6378245*(1-r)/(a*s)*Math.PI);return[t+(i=180*i/(6378245/s*Math.cos(o)*Math.PI)),e+n]}},{key:"gcj02towgs84",value:function(t,e){var r=.006693421622965943;if(this.out_of_china(t,e))return[t,e];var n=this.transformlat(t-105,e-35),i=this.transformlng(t-105,e-35),o=e/180*Math.PI,a=1-r*(a=Math.sin(o))*a,s=Math.sqrt(a),n=180*n/(6378245*(1-r)/(a*s)*Math.PI);return[2*t-(t+(i=180*i/(6378245/s*Math.cos(o)*Math.PI))),2*e-(e+n)]}},{key:"bd09togcj02",value:function(t,e){var r=t-.0065,t=e-.006,e=Math.sqrt(r*r+t*t)-2e-5*Math.sin(t*Math.PI*3e3/180),r=Math.atan2(t,r)-3e-6*Math.cos(r*Math.PI*3e3/180);return[e*Math.cos(r),e*Math.sin(r)]}},{key:"bd09towgs84",value:function(t,e){e=this.bd09togcj02(t,e);return this.gcj02towgs84(e[0],e[1])}},{key:"out_of_china",value:function(t,e){return t<72.004||137.8347<t||(e<.8293||55.8271<e)}},{key:"transformlat",value:function(t,e){var r=2*t-100+3*e+.2*e*e+.1*t*e+.2*Math.sqrt(Math.abs(t));return r+=2*(20*Math.sin(6*t*Math.PI)+20*Math.sin(2*t*Math.PI))/3,r+=2*(20*Math.sin(e*Math.PI)+40*Math.sin(e/3*Math.PI))/3,r+=2*(160*Math.sin(e/12*Math.PI)+320*Math.sin(e*Math.PI/30))/3}},{key:"transformlng",value:function(t,e){e=300+t+2*e+.1*t*t+.1*t*e+.1*Math.sqrt(Math.abs(t));return e+=2*(20*Math.sin(6*t*Math.PI)+20*Math.sin(2*t*Math.PI))/3,e+=2*(20*Math.sin(t*Math.PI)+40*Math.sin(t/3*Math.PI))/3,e+=2*(150*Math.sin(t/12*Math.PI)+300*Math.sin(t/30*Math.PI))/3}}]),e);function e(){r(this,e),this._pixelSize=512,this._worldRadius=6378137}var o=(t(a,[{key:"setSpeed",value:function(t){this.stepLimit=t}},{key:"setPos",value:function(t,e){if(!(t instanceof Array&&e instanceof Array))throw new Error("MovingNode setPos error");this.currentPos=t;for(var r=0;r<e.length;r++){var n=e[r][0],i=e[r][1],o=e[r][2];if(0===r){var a=this.currentPos[0],s=this.currentPos[1],h=this.currentPos[2],u=new ht.Math.Vector3(a,s,h),u=new ht.Math.Vector3(n,i,o).distanceTo(u);if(u>this.stepLimit)for(var l=Math.ceil(u/this.stepLimit),c=(n-a)/l,p=(i-s)/l,d=(o-h)/l,v=1;v<=l;v++)this.destinationPos.push([a+v*c,s+v*p,h+v*d]);else this.destinationPos.push([n,i,o])}else{var g=e[r-1][0],f=e[r-1][1],y=e[r-1][2],u=new ht.Math.Vector3(g,f,y),u=new ht.Math.Vector3(n,i,o).distanceTo(u);if(u>this.stepLimit)for(var m=Math.ceil(u/this.stepLimit),x=(n-g)/m,b=(i-f)/m,w=(o-y)/m,_=1;_<=m;_++)this.destinationPos.push([g+_*x,f+_*b,y+_*w]);else this.destinationPos.push([n,i,o])}}this.movingLoop&&(this.currentPosCopy=this.currentPos.slice(),this.destinationPosCopy=this.destinationPos.slice())}},{key:"setPosToCurrent",value:function(){this.currentPos&&this.currentPos.length&&this.node.p3(this.currentPos[0],this.currentPos[1],this.currentPos[2]),this.destinationPos.length&&this.rotateToNextPos()}},{key:"rotateToNextPos",value:function(){var t=new ht.Math.Vector3(this.currentPos[0],this.currentPos[1],this.currentPos[2]),e=new ht.Math.Vector3(this.destinationPos[0][0],this.destinationPos[0][1],this.destinationPos[0][2]);this.currDirection=new ht.Math.Vector3,this.currDirection.subVectors(e,t).setLength(1),this.currDirection.x.toFixed(4)===this.beforeDirection.x.toFixed(4)&&this.currDirection.z.toFixed(4)===this.beforeDirection.z.toFixed(4)||(t=this.beforeDirection.angleTo(this.currDirection),0<=this.currDirection.x*this.beforeDirection.x&&0<=this.currDirection.z*this.beforeDirection.z?0<this.beforeDirection.x||0<this.currDirection.x?this.beforeDirection.z<=this.currDirection.z?this.rotateNodeY(!0,t):this.rotateNodeY(!1,t):(this.beforeDirection.x<0||this.currDirection.x<0)&&(this.beforeDirection.z<=this.currDirection.z?this.rotateNodeY(!1,t):this.rotateNodeY(!0,t)):this.currDirection.x*this.beforeDirection.x*this.currDirection.z*this.beforeDirection.z<=0?0<=this.currDirection.z?0<=this.beforeDirection.x?this.rotateNodeY(!0,t):this.rotateNodeY(!1,t):0<=this.beforeDirection.x?this.rotateNodeY(!1,t):this.rotateNodeY(!0,t):this.currDirection.x*this.beforeDirection.x<=0&&this.currDirection.z*this.beforeDirection.z<=0&&(0<=this.currDirection.x*this.currDirection.z?Math.abs(this.currDirection.z)>=Math.abs(this.beforeDirection.z)?this.rotateNodeY(!1,t):this.rotateNodeY(!0,t):Math.abs(this.currDirection.z)>=Math.abs(this.beforeDirection.z)?this.rotateNodeY(!0,t):this.rotateNodeY(!1,t)),this.beforeDirection=this.currDirection.clone())}},{key:"rotateNodeY",value:function(t,e){t?this.node.setRotationY(this.node.getRotationY()-e):this.node.setRotationY(this.node.getRotationY()+e)}},{key:"moving",value:function(){if(this.currentPos!==this.destinationPos[0]){if(this.currentPos=this.destinationPos[0],this.destinationPos.shift(),this.setPosToCurrent(),0===this.destinationPos.length){if(!this.movingLoop)return!1;this.currentPos=this.currentPosCopy.slice(),this.destinationPos=this.destinationPosCopy.slice(),this.setPosToCurrent()}return!0}}}]),a);function a(t){r(this,a),this.node=t,this.beforeDirection=new ht.Math.Vector3(1,0,0),this.currDirection=null,this.follow=!1,this.currentPos=[],this.currentPosCopy=[],this.destinationPos=[],this.destinationPosCopy=[],this.movingLoop=!1,this.stepLimit=1}var s=(t(h,[{key:"init",value:function(t){p()&&t&&this.initMap(t)&&(t.renderHTML||t.graph3dView?this.initG3d(!0):this.initG3d(!1))}},{key:"initMap",value:function(t){var a=this;if(!mapboxgl)return console.warn("Network error, mapbox not work!"),!1;if(!t.center)return console.warn("you have to set map center"),!1;t.accessToken||(console.warn("need mapbox access token to run this engine!"),t.accessToken="pk.eyJ1IjoiYmJveXpoaHgiLCJhIjoiY2s4cjd4NWtjMDc2NDNkbXNkOWsyM2V5YyJ9.lGgJMqK_BkIYtgwhJ2rS1g"),t.bearing=t.bearing||0,t.pitch=t.pitch||60,t.zoom=t.zoom||15,t.style=t.style||"mapbox://styles/mapbox/dark-v9",this._originParams=t,this._mapOrigin=t.center,ht.mapbox.center=t.center;var e=void 0,r=function(t){t.container?e=document.getElementById(t.container):(t.container="map",(e=document.createElement("div")).id=t.container,e.style.position="absolute",e.style.width="100%",e.style.height="100%",document.body.appendChild(e))};if(t.renderHTML||t.graph3dView){if(!t.graph3dView)return void console.error("ht-mapbox need a graph3dView to initialize");this._graph3dView=t.graph3dView,r(t)}else this._graph3dView=new ht.graph3d.Graph3dView,r(t);this._container=t.container;var s=new ht.map.HTGisConverter,n=s.getGroundResolution(this._mapOrigin[1])/s._pixelSize,r=[0,0,0],h={translateX:mapboxgl.MercatorCoordinate.fromLngLat(this._mapOrigin,0).x,translateY:mapboxgl.MercatorCoordinate.fromLngLat(this._mapOrigin,0).y,translateZ:mapboxgl.MercatorCoordinate.fromLngLat(this._mapOrigin,0).z,rotateX:r[0],rotateY:r[1],rotateZ:r[2],scale:n};mapboxgl.accessToken=t.accessToken;var i=new mapboxgl.Map({container:t.container,style:t.style,center:t.center,bearing:t.bearing,zoom:t.zoom,pitch:t.pitch,localIdeographFontFamily:"sans-serif"});i.scrollZoom.setZoomRate(.01),i.setMinPitch(1),this._map=i;var o={id:"3d-model",type:"custom",renderingMode:"3d",onAdd:function(t,e){},render:function(t,e){var r=(new ht.Math.Matrix4).makeRotationAxis(new ht.Math.Vector3(1,0,0),h.rotateX),n=(new ht.Math.Matrix4).makeRotationAxis(new ht.Math.Vector3(0,1,0),h.rotateY),i=(new ht.Math.Matrix4).makeRotationAxis(new ht.Math.Vector3(0,0,1),h.rotateZ),o=(new ht.Math.Matrix4).fromArray(e),e=new ht.Math.Matrix4;e.set(1,0,0,h.translateX,0,1,0,h.translateY,0,0,1,h.translateZ,0,0,0,1),e.scale(new ht.Math.Vector3(h.scale,-h.scale,h.scale)),e.multiply(r),e.multiply(n),e.multiply(i);o=o.multiply(e),e=a.getEyePos(o),o=a._map.getCenter(),o=s.getXY([o.lng,o.lat],a._mapOrigin);isNaN(o.x)&&(o.x=0),isNaN(o.y)&&(o.y=0),a._graph3dView.setEye([Math.fround(e.x),Math.fround(e.z),-Math.fround(e.y)]),a._graph3dView.setCenter([Math.fround(o.x),0,Math.fround(o.y)]),a._graph3dView.validate()}};return i.on("style.load",function(){i.addLayer(o),!t.renderHTML&&t.graph3dView&&t.graph3dView.addToDOM(e)}),!0}},{key:"initG3d",value:function(t){ht.map._graph3dView=this._graph3dView,this._graph3dView.getView().style.pointerEvents="none",this._graph3dView.setFar(25e4),this._graph3dView.setFovy(.6435011087932844),this._graph3dView.setNear(10),t||this._graph3dView.addToDOM()}},{key:"getEyePos",value:function(t){var e=new ht.Math.Matrix4;e.getInverse(t);var r=new ht.Math.Vector3(0,0,1).applyMatrix4(e),n=new ht.Math.Vector3(0,0,-1).applyMatrix4(e),t=new ht.Math.Vector3(n.x-r.x,n.y-r.y,n.z-r.z),n=new ht.Math.Vector3(0,1,1).applyMatrix4(e),e=new ht.Math.Vector3(0,1,-1).applyMatrix4(e),e=new ht.Math.Vector3(e.x-n.x,e.y-n.y,e.z-n.z),t=(t.z*(r.y-n.y)+t.y*(n.z-r.z))/(e.y*t.z-t.y*e.z);return e.clone().multiplyScalar(t).add(n)}},{key:"getConvert",value:function(){if(p())return this._convert}},{key:"getGraphView3d",value:function(){return this._graph3dView}},{key:"flyTo",value:function(t,e){var r,n,i,o,a;t&&(r=t.zoom||15,n=t.center||this._mapOrigin,i=t.bearing||0,o=t.pitch||60,a=t.easing?t:function(t){return t*(2-t)},t=t.duration||500,this._map.easeTo({zoom:r,center:n,bearing:i,pitch:o,easing:a,duration:t}),e&&setTimeout(function(){e()},t))}},{key:"on",value:function(t,e){this._map.on(t,function(){e(this._graph3dView)}).bind(this)}},{key:"enableBloom",value:function(t,e){t?(this._graph3dView.enablePostProcessing("Bloom",!0),t=this._graph3dView.getPostProcessingModule("Bloom"),e?(t.strength=e.strength||.8,t.threshold=e.threshold||.2,t.radius=e.radius||.6):(t.strength=.8,t.threshold=.2,t.radius=.6),this._graph3dView.getPostProcessingModule("Bloom").overrideAlpha=!1):this._graph3dView.enablePostProcessing("Bloom",!1)}},{key:"enableSnow",value:function(t){var u,e,r,n=this,i=[];t&&(u=this._graph3dView.dm(),t=(e=function(t,e,r){for(var n=[],i=0;i<t;i++){var o=Math.random()*e-e/2,a=Math.random()*e,s=Math.random()*e-e/2;n.push(o,a,s)}var h=new ht.Points;return h.setPoints(n),h.s(r),h.s({"3d.movable":!1,"3d.selectable":!1}),h.s3(1,1,1),h.a("type","snow"),u.add(h),h})(1e6,4e4,{"points.image":"res/snow/snow.png","points.transparent":!0,"points.size":30,"points.opacity":.6}),i.push(t),t=e(1e6,4e4,{"points.image":"res/snow/snow2.png","points.transparent":!0,"points.size":30,"points.opacity":.6}),i.push(t),t=e(1e6,4e4,{"points.image":"res/snow/snow3.png","points.transparent":!0,"points.size":30,"points.opacity":.6}),i.push(t),t=e(1e6,4e4,{"points.image":"res/snow/snow4.png","points.transparent":!0,"points.size":30,"points.opacity":.6}),i.push(t),e=e(1e6,4e4,{"points.image":"res/snow/snow5.png","points.transparent":!0,"points.size":30,"points.opacity":.6}),i.push(e),r=0,u.addScheduleTask({action:function(t){"snow"===t.a("type")&&(35e3<r?(t.translateTop(35e3),r=0):(t.translateBottom(1),r++))}})),this._map.on("zoom",function(t){n._map.getZoom()<12?i.forEach(function(t){t.s({"points.opacity":0})}):i.forEach(function(t){t.s({"points.opacity":.6})})})}},{key:"loadGeoJson",value:function(t){t||console.warn("data can't be empty"),"string"==typeof t&&(t=JSON.parse(t)),new ht.map.GeoJsonLoader(this._graph3dView,this._mapOrigin,this._map).loadData(t)}},{key:"loadMsgPoint",value:function(t){t?("string"==typeof t&&(t=JSON.parse(t)),new ht.map.MsgPointLoader(this._graph3dView,this._mapOrigin,this._map).loadData(t)):console.warn("data can't be empty")}},{key:"loadAreaDivision",value:function(t){t?("string"==typeof t&&(t=JSON.parse(t)),new ht.map.AreaDivisionLoader(this._graph3dView,this._mapOrigin).loadData(t)):console.warn("data can't be empty")}},{key:"loadHistogram",value:function(t){t?("string"==typeof t&&(t=JSON.parse(t)),new ht.map.HistogramLoader(this._graph3dView,this._mapOrigin).loadData(t)):console.warn("data can't be empty")}},{key:"loadTrajectory",value:function(t){t?("string"==typeof t&&(t=JSON.parse(t)),new ht.map.TrajectoryLoader(this._graph3dView,this._mapOrigin,this._map).loadData(t)):console.warn("data can't be empty")}},{key:"loadTrafficFlow",value:function(t,e){var r;t?("string"==typeof t&&(t=JSON.parse(t)),e=e||.05,(r=new ht.map.TrafficFlow(this._graph3dView,this._mapOrigin,e)).setSpeed(e),r.loadData(t)):console.warn("data can't be empty")}},{key:"loadBillboard",value:function(t,e,r){var n=new ht.map.HTGisConverter,i=new ht.Node;i.s({shape3d:"billboard","shape3d.image":r=r||"res/company.json","shape3d.autorotate":!0,"shape3d.vector.dynamic":!0}),i.setTag("billboard0"),i.setScale3d(3,3,1);t=n.getXY([t.lng,t.lat],this._mapOrigin);i.setPosition3d(t.x,0,t.y),i.setElevation(i.getSize3d()[1]*i.getScale3d()[1]/2+e),this._graph3dView.dm().add(i)}},{key:"loadMarker",value:function(t,e,r){var n=(new ht.map.HTGisConverter).getXY([t.lng,t.lat],this._mapOrigin),t=new ht.Node;t.s({shape3d:r=r||"res/objs/triangle3d.json","body.color":"#FF0000"}),t.a({type:"marker"}),t.setScale3d(50,50,50),t.setPosition3d(n.x,0,n.y),t.setElevation(t.getSize3d()[1]*t.getScale3d()[1]/2+e),this._markers.push(t),this._graph3dView.dm().add(t)}}]),h);function h(t){r(this,h),this._graphView=null,this._graph3dView=null,this._mapOrigin=null,this._container=null,this._convert=new J,this._poses=[],this._points=null,this._buildingNum=0,this._buildings=[],this._originParams=null,this._markers=[],this._map=null,t&&this.init(t)}var u=(function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(l,ht.Node),t(l,[{key:"checkParams",value:function(t){p()&&(this.addListenerToNode(),this.setProperty(t))}},{key:"addListenerToNode",value:function(){var r=this;this.onPropertyChanged=function(t){var e=t.property,t=t.newValue;"position"===e&&r._center&&(e=r._convert.getLngLat({x:t.x,y:t.y},r._center),r._worldCoordinate=[t.x,r.getElevation(),t.y],r._center=e)}}},{key:"setProperty",value:function(t){var e,r,n,i;t&&(this._center=t.center,this._center&&(e=t.rotation||[0,0,0],r=t.scale||[1,1,1],n=t.height||0,i={x:0,y:0},(t=t.lngLat)&&(i=this._convert.getXY(t,this._center),this._worldCoordinate=[i.x,n,i.y],this.setPosition3d(i.x,n,i.y),this.setRotation3d(e[0],e[1],e[2]),this.setScale3d(r[0],r[1],r[2]),this.setElevation(n+this.getSize3d()[1]*this.getScale3d()[1]/2))))}},{key:"setCenter",value:function(t){Array.isArray(t)&&t.length&&(t=this._convert.getXY(t,this._center),this.setPosition3d(t.x,this.getElevation(),t.y))}},{key:"addToMap",value:function(){ht.map._graph3dView.dm().add(this)}},{key:"remove",value:function(){ht.map._graph3dView.dm().remove(this)}}]),l);function l(t){r(this,l);var e=i(this,(l.__proto__||Object.getPrototypeOf(l)).call(this));return e._center=null,e._worldCoordinate=null,e._convert=new J,t&&e.checkParams(t),e}var c=(t(d,[{key:"getOffset",value:function(){return this._offset}},{key:"size",value:function(){return this._dv.buffer.byteLength}},{key:"skip",value:function(t){this._offset+=t}},{key:"getBoolean",value:function(){return 1==(1&this.getUint8())}},{key:"getBooleanArray",value:function(t){for(var e=[],r=0;r<t;r++)e.push(this.getBoolean());return e}},{key:"getUint8",value:function(){var t=this._dv.getUint8(this._offset);return this._offset+=1,t}},{key:"getInt16",value:function(){var t=this._dv.getInt16(this._offset,this._littleEndian);return this._offset+=2,t}},{key:"getInt32",value:function(){var t=this._dv.getInt32(this._offset,this._littleEndian);return this._offset+=4,t}},{key:"getInt32Array",value:function(t){for(var e=[],r=0;r<t;r++)e.push(this.getInt32());return e}},{key:"getUint32",value:function(){var t=this._dv.getUint32(this._offset,this._littleEndian);return this._offset+=4,t}},{key:"getInt64",value:function(){var t=void 0,e=void 0;return this._littleEndian?(t=this.getUint32(),e=this.getUint32()):(e=this.getUint32(),t=this.getUint32()),2147483648&e?(e=4294967295&~e,-(4294967296*(e=4294967295===(t=4294967295&~t)?e+1&4294967295:e)+(t=t+1&4294967295))):4294967296*e+t}},{key:"getInt64Array",value:function(t){for(var e=[],r=0;r<t;r++)e.push(this.getInt64());return e}},{key:"getUint64",value:function(){var t=void 0,e=void 0;return this._littleEndian?(t=this.getUint32(),e=this.getUint32()):(e=this.getUint32(),t=this.getUint32()),4294967296*e+t}},{key:"getFloat32",value:function(){var t=this._dv.getFloat32(this._offset,this._littleEndian);return this._offset+=4,t}},{key:"getFloat32Array",value:function(t){for(var e=[],r=0;r<t;r++)e.push(this.getFloat32());return e}},{key:"getFloat64",value:function(){var t=this._dv.getFloat64(this._offset,this._littleEndian);return this._offset+=8,t}},{key:"getFloat64Array",value:function(t){for(var e=[],r=0;r<t;r++)e.push(this.getFloat64());return e}},{key:"getArrayBuffer",value:function(t){var e=this._dv.buffer.slice(this._offset,this._offset+t);return this._offset+=t,e}}]),d);function d(t,e){r(this,d),this._dv=new DataView(t),this._offset=0,this._littleEndian=void 0===e||e}var v=(t(g,[{key:"parse",value:function(t){if(Zlib){var e=new Zlib.Gunzip(new Uint8Array(t)).decompress(),r=new c(e.buffer);r.littleEndian=0!==e[0];var n=r.getInt32Array(5);if(1752460642===n[0]){t=n[2],e=n[3],n=n[4];return{vs:r.getFloat32Array(t),ns:r.getFloat32Array(e),uv:r.getFloat32Array(n)}}console.error("must be ht file")}}}]),g);function g(){r(this,g)}var f=(t(y,[{key:"getPerpendicularPointsForStraightRoad",value:function(t){for(var e,r,n=(1<arguments.length&&void 0!==arguments[1]?arguments[1]:10)/2,i=[],o=[],a=0;a<t.length;a+=3)void 0!==t[a+3]&&(e=new ht.Math.Vector2(t[a],t[a+2]),r=new ht.Math.Vector2(t[a+3],t[a+5]),r=this.getPerpendicularPoints(e,r,n),i.push(r[0].x),i.push(t[a+1]),i.push(r[0].y),i.push(r[2].x),i.push(t[a+4]),i.push(r[2].y),o.push(r[1].x),o.push(t[a+1]),o.push(r[1].y),o.push(r[3].x),o.push(t[a+4]),o.push(r[3].y));return{up:i=this.getCrossPos(i),down:o=this.getCrossPos(o)}}},{key:"getPerpendicularPoints",value:function(t,e){var r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:10;t instanceof ht.Math.Vector3&&(t=new ht.Math.Vector2(t.x,t.z),e=new ht.Math.Vector2(e.x,e.z));var n=new ht.Math.Vector2;n.subVectors(e,t),n.rotateAround(new ht.Math.Vector2(0,0),-Math.PI/2),n.setLength(r);var i=n.clone();i.rotateAround(new ht.Math.Vector2(0,0),-Math.PI);var o=n.clone(),r=i.clone();return n.add(t),i.add(t),o.add(e),r.add(e),[n,i,o,r]}},{key:"getCrossPos",value:function(t){var e=[];e.push(t[0],t[1],t[2]);for(var r,n,i,o,a=0;a<t.length;a+=6)void 0!==t[a+11]&&(r=new ht.Math.Vector2(t[a],t[a+2]),n=new ht.Math.Vector2(t[a+3],t[a+5]),i=new ht.Math.Vector2(t[a+6],t[a+8]),o=new ht.Math.Vector2(t[a+9],t[a+11]),o=this.getTwoLinesCrossPoint(r,n,i,o),e.push(o.x,t[a+1],o.y));return e.push(t[t.length-3],t[t.length-2],t[t.length-1]),e}},{key:"getTwoLinesCrossPoint",value:function(t,e,r,n){if(t.distanceTo(r)<1e-4)return new ht.Math.Vector2(t.x,t.y);if(t.distanceTo(n)<1e-4)return new ht.Math.Vector2(t.x,t.y);if(e.distanceTo(r)<1e-4)return new ht.Math.Vector2(e.x,e.y);if(e.distanceTo(n)<1e-4)return new ht.Math.Vector2(e.x,e.y);var i=(e.y-t.y)/(e.x-t.x),o=void 0,a=void 0,s=void 0,t=void 0,o=i==1/0||i==-1/0?e.x:e.y-i*e.x,r=(n.y-r.y)/(n.x-r.x),a=r==1/0||r==-1/0?n.x:n.y-r*n.x;return i!=1/0&&i!=-1/0||r!=1/0&&r!=-1/0?(t=i==1/0||i==-1/0?r*(s=o)+a:r==1/0||r==-1/0?i*(s=a)+o:i*(s=(a-o)/(i-r))+o,{x:s,y:t}):null}}]),y);function y(){r(this,y)}function m(){}(m.prototype.constructor=m).prototype.downLoadData=function(t){var e=t.vs,r=void 0,n=void 0,r=t.uv||[],n=t.ns||[],i=new Uint32Array(5);i[0]=1752460642,i[1]=1,i[2]=e.length,i[3]=n.length,i[4]=r.length;for(var o=new Float32Array(e.length),a=0;a<e.length;a++)o[a]=e[a];for(var s=new Float32Array(n.length),h=0;h<n.length;h++)s[h]=n[h];for(var u=new Float32Array(r.length),l=0;l<r.length;l++)u[l]=r[l];t=new Blob([i,o,s,u],{type:"application/octet-stream"}),i=document.createElement("a");i.style.display="none",document.body.appendChild(i),i.href=URL.createObjectURL(t),i.download="data.htmb",i.click(),document.body.removeChild(i)};function x(t,e,r){this.onStart=void 0,this.onLoad=t,this.onProgress=e,this.onError=r,this.isLoading=!1,this.itemsLoaded=0,this.itemsTotal=0,this.urlModifier=void 0}(x.prototype.constructor=x).prototype.itemStart=function(t){this.itemsTotal++,!1===this.isLoading&&void 0!==this.onStart&&this.onStart(t,this.itemsLoaded,this.itemsTotal),this.isLoading=!0},x.prototype.itemEnd=function(t){this.itemsLoaded++,void 0!==this.onProgress&&this.onProgress(t,this.itemsLoaded,this.itemsTotal),this.itemsLoaded===this.itemsTotal&&(this.isLoading=!1,void 0!==this.onLoad&&this.onLoad())},x.prototype.itemError=function(t){void 0!==this.onError&&this.onError(t)},x.prototype.resolveURL=function(t){return this.urlModifier?this.urlModifier(t):t};function b(t){this.manager=t,this.loading={}}(b.prototype.constructor=b).prototype.load=function(u,t,e,r){void 0===u&&(u=""),void 0!==this.path&&(u=this.path+u),u=this.manager.resolveURL(u);var l=this;if(void 0===l.loading[u]){var n=u.match(/^data:(.*?)(;base64)?,(.*)$/),i=void 0;if(n){var o=n[1],a=!!n[2],s=n[3],s=decodeURIComponent(s);a&&(s=atob(s));try{var h=void 0,c=(this.responseType||"").toLowerCase();switch(c){case"arraybuffer":case"blob":for(var p=new Uint8Array(s.length),d=0;d<s.length;d++)p[d]=s.charCodeAt(d);h="blob"===c?new Blob([p.buffer],{type:o}):p.buffer;break;case"document":h=(new DOMParser).parseFromString(s,o);break;case"json":h=JSON.parse(s);break;default:h=s}setTimeout(function(){t&&t(h),l.manager.itemEnd(u)},0)}catch(t){setTimeout(function(){r&&r(t),l.manager.itemError(u),l.manager.itemEnd(u)},0)}}else{for(var v in l.loading[u]=[],l.loading[u].push({onLoad:t,onProgress:e,onError:r}),(i=new XMLHttpRequest).open("GET",u,!0),i.addEventListener("load",function(t){var e=this.response,r=l.loading[u];if(delete l.loading[u],200===this.status||0===this.status){0===this.status&&console.warn("HTTP Status 0 received.");for(var n=0,i=r.length;n<i;n++){var o=r[n];o.onLoad&&o.onLoad(e)}l.manager.itemEnd(u)}else{for(var a=0,s=r.length;a<s;a++){var h=r[a];h.onError&&h.onError(t)}l.manager.itemError(u),l.manager.itemEnd(u)}},!1),i.addEventListener("progress",function(t){for(var e=l.loading[u],r=0,n=e.length;r<n;r++){var i=e[r];i.onProgress&&i.onProgress(t)}},!1),i.addEventListener("error",function(t){var e=l.loading[u];delete l.loading[u];for(var r=0,n=e.length;r<n;r++){var i=e[r];i.onError&&i.onError(t)}l.manager.itemError(u),l.manager.itemEnd(u)},!1),i.addEventListener("abort",function(t){var e=l.loading[u];delete l.loading[u];for(var r=0,n=e.length;r<n;r++){var i=e[r];i.onError&&i.onError(t)}l.manager.itemError(u),l.manager.itemEnd(u)},!1),void 0!==this.responseType&&(i.responseType=this.responseType),void 0!==this.withCredentials&&(i.withCredentials=this.withCredentials),i.overrideMimeType&&i.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain"),this.requestHeader)i.setRequestHeader(v,this.requestHeader[v]);i.send(null)}return l.manager.itemStart(u),i}l[u].push({onLoad:t,onProgress:e,onError:r})},b.prototype.setPath=function(t){return this.path=t,this},b.prototype.setResponseType=function(t){return this.responseType=t,this},b.prototype.setMimeType=function(t){return this.mimeType=t,this},b.prototype.setRequestHeader=function(t){return this.requestHeader=t,this};var w=function(t,e,r){this.name="",this.array=t,this.itemSize=e,this.count=void 0!==t?t.length/e:0,this.normalized=!0===r,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.version=0};function k(t,e,r){w.call(this,new Float32Array(t),e,r)}(w.prototype.constructor=w).prototype.setArray=function(t){return this.count=void 0!==t?t.length/this.itemSize:0,this.array=t,this},w.prototype.set=function(t,e){return this.array.set(t,e=void 0===e?0:e),this},(k.prototype=Object.create(w.prototype)).constructor=k;var S=function(){this.name="",this.index=null,this.attributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0},this.userData={}};(S.prototype.constructor=S).prototype.setAttribute=function(t,e){return this.attributes[t]=e,this};function _(){this.manager=new x,this.materials=null,this.object_pattern=/^[og]\s*(.+)?/,this.material_library_pattern=/^mtllib /,this.material_use_pattern=/^usemtl /,this.map_use_pattern=/^usemap /,this.path=""}(_.prototype.constructor=_).prototype.load=function(t,e,r,n){var i=this,o=new b(i.manager);o.setPath(this.path),o.load(t,function(t){e(i.parse(t))},r,n)},_.prototype.setPath=function(t){return this.path=t,this},_.prototype.parse=function(t){for(var e,r,n,i,o=new N,a=(t=-1!==(t=-1!==t.indexOf("\r\n")?t.replace(/\r\n/g,"\n"):t).indexOf("\\\n")?t.replace(/\\\n/g,""):t).split("\n"),s="",h=[],u="function"==typeof"".trimLeft,l=0,c=a.length;l<c;l++)if(s=a[l],s=u?s.trimLeft():s.trim(),r=s.length,0!==r&&"#"!==(e=s.charAt(0)))if("v"===e){var p=s.split(/\s+/);switch(p[0]){case"v":o.vertices.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3])),7<=p.length?o.colors.push(parseFloat(p[4]),parseFloat(p[5]),parseFloat(p[6])):o.colors.push(void 0,void 0,void 0);break;case"vn":o.normals.push(parseFloat(p[1]),parseFloat(p[2]),parseFloat(p[3]));break;case"vt":o.uvs.push(parseFloat(p[1]),parseFloat(p[2]))}}else if("f"===e){for(var d=s.substr(1).trim().split(/\s+/),v=[],g=0,f=d.length;g<f;g++){var y=d[g];0<y.length&&(y=y.split("/"),v.push(y))}for(var m=v[0],x=1,b=v.length-1;x<b;x++){var w=v[x],_=v[x+1];o.addFace(m[0],w[0],_[0],m[1],w[1],_[1],m[2],w[2],_[2])}}else if("l"===e){var M=s.substring(1).trim().split(" "),A=[],P=[];if(-1===s.indexOf("/"))A=M;else for(var D=0,I=M.length;D<I;D++){var V=M[D].split("/");""!==V[0]&&A.push(V[0]),""!==V[1]&&P.push(V[1])}o.addLineGeometry(A,P)}else"p"===e?(n=s.substr(1).trim().split(" "),o.addPointGeometry(n)):null!==(h=this.object_pattern.exec(s))?(n=(" "+h[0].substr(1).trim()).substr(1),o.startObject(n)):this.material_use_pattern.test(s)?o.object.startMaterial(s.substring(7).trim(),o.materialLibraries):this.material_library_pattern.test(s)?o.materialLibraries.push(s.substring(7).trim()):this.map_use_pattern.test(s)?console.warn("."):"s"===e&&(1<(h=s.split(" ")).length?(i=h[1].trim().toLowerCase(),o.object.smooth="0"!==i&&"off"!==i):o.object.smooth=!0,(i=o.object.currentMaterial())&&(i.smooth=o.object.smooth));o.finalize();for(var C=[],L=0,E=o.objects.length;L<E;L++){var T,z=o.objects[L].geometry;0!==z.vertices.length&&((T=new S).setAttribute("position",new k(z.vertices,3)),!0===z.hasNormalIndices&&T.setAttribute("normal",new k(z.normals,3)),0<z.colors.length&&T.setAttribute("color",new k(z.colors,3)),!0===z.hasUVIndices&&T.setAttribute("uv",new k(z.uvs,2)),C.push(T))}return C};var N=function(){this.objects=[],this.object={},this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.materialLibraries=[],this.startObject("",!1)};(N.prototype.constructor=N).prototype.startObject=function(t,e){if(this.object&&!1===this.object.fromDeclaration)return this.object.name=t,void(this.object.fromDeclaration=!1!==e);var r=this.object&&"function"==typeof this.object.currentMaterial?this.object.currentMaterial():void 0;this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0),this.object={name:t||"",fromDeclaration:!1!==e,geometry:{vertices:[],normals:[],colors:[],uvs:[],hasNormalIndices:!1,hasUVIndices:!1},materials:[],smooth:!0,startMaterial:function(t,e){var r=this._finalize(!1);r&&(r.inherited||r.groupCount<=0)&&this.materials.splice(r.index,1);r={index:this.materials.length,name:t||"",mtllib:Array.isArray(e)&&0<e.length?e[e.length-1]:"",smooth:(void 0!==r?r:this).smooth,groupStart:void 0!==r?r.groupEnd:0,groupEnd:-1,groupCount:-1,inherited:!1,clone:function(t){t={index:"number"==typeof t?t:this.index,name:this.name,mtllib:this.mtllib,smooth:this.smooth,groupStart:0,groupEnd:-1,groupCount:-1,inherited:!1};return t.clone=this.clone.bind(t),t}};return this.materials.push(r),r},currentMaterial:function(){if(0<this.materials.length)return this.materials[this.materials.length-1]},_finalize:function(t){var e=this.currentMaterial();if(e&&-1===e.groupEnd&&(e.groupEnd=this.geometry.vertices.length/3,e.groupCount=e.groupEnd-e.groupStart,e.inherited=!1),t&&1<this.materials.length)for(var r=this.materials.length-1;0<=r;r--)this.materials[r].groupCount<=0&&this.materials.splice(r,1);return t&&0===this.materials.length&&this.materials.push({name:"",smooth:this.smooth}),e}},r&&r.name&&"function"==typeof r.clone&&((r=r.clone(0)).inherited=!0,this.object.materials.push(r)),this.objects.push(this.object)},N.prototype.addFace=function(t,e,r,n,i,o,a,s,h){var u,l=this.vertices.length,t=this.parseVertexIndex(t,l),e=this.parseVertexIndex(e,l),l=this.parseVertexIndex(r,l);this.addVertex(t,e,l),void 0!==n&&""!==n&&(u=this.uvs.length,t=this.parseUVIndex(n,u),e=this.parseUVIndex(i,u),l=this.parseUVIndex(o,u),this.addUV(t,e,l)),void 0!==a&&""!==a&&(u=this.normals.length,t=this.parseNormalIndex(a,u),e=a===s?t:this.parseNormalIndex(s,u),l=a===h?t:this.parseNormalIndex(h,u),this.addNormal(t,e,l))},N.prototype.parseVertexIndex=function(t,e){t=parseInt(t,10);return 3*(0<=t?t-1:t+e/3)},N.prototype.addVertex=function(t,e,r){var n=this.vertices,i=this.object.geometry.vertices;i.push(n[t+0],n[t+1],n[t+2]),i.push(n[e+0],n[e+1],n[e+2]),i.push(n[r+0],n[r+1],n[r+2])},N.prototype.parseUVIndex=function(t,e){t=parseInt(t,10);return 2*(0<=t?t-1:t+e/2)},N.prototype.addUV=function(t,e,r){var n=this.uvs,i=this.object.geometry.uvs;i.push(n[t+0],n[t+1]),i.push(n[e+0],n[e+1]),i.push(n[r+0],n[r+1])},N.prototype.parseNormalIndex=function(t,e){t=parseInt(t,10);return 3*(0<=t?t-1:t+e/3)},N.prototype.addNormal=function(t,e,r){var n=this.normals,i=this.object.geometry.normals;i.push(n[t+0],n[t+1],n[t+2]),i.push(n[e+0],n[e+1],n[e+2]),i.push(n[r+0],n[r+1],n[r+2])},N.prototype.finalize=function(){this.object&&"function"==typeof this.object._finalize&&this.object._finalize(!0)},N.prototype.addLineGeometry=function(t,e){this.object.geometry.type="Line";for(var r=this.vertices.length,n=this.uvs.length,i=0,o=t.length;i<o;i++)this.addVertexLine(this.parseVertexIndex(t[i],r));for(var a=0,s=e.length;a<s;a++)this.addUVLine(this.parseUVIndex(e[a],n))},N.prototype.addVertexLine=function(t){var e=this.vertices;this.object.geometry.vertices.push(e[t+0],e[t+1],e[t+2])},N.prototype.addUVLine=function(t){var e=this.uvs;this.object.geometry.uvs.push(e[t+0],e[t+1])},N.prototype.addPointGeometry=function(t){this.object.geometry.type="Points";for(var e=this.vertices.length,r=0,n=t.length;r<n;r++)this.addVertexPoint(this.parseVertexIndex(t[r],e))},N.prototype.addVertexPoint=function(t){var e=this.vertices;this.object.geometry.vertices.push(e[t+0],e[t+1],e[t+2])};function M(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:new ht.Math.Vector2,e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new ht.Math.Vector2;this.v1=t,this.v2=e}M.prototype.getPoint=function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new ht.Math.Vector2;return 1===t?e.copy(this.v2):(e.copy(this.v2).sub(this.v1),e.multiplyScalar(t).add(this.v1)),e},M.prototype.getPointAt=function(t,e){return this.getPoint(t,e)},M.prototype.getLengths=function(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:200;if(this.cacheArcLengths&&this.cacheArcLengths.length===t+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var e=[],r=void 0,n=this.getPoint(0),i=0;e.push(0);for(var o=1;o<=t;o++)i+=(r=this.getPoint(o/t)).distanceTo(n),e.push(i),n=r;return this.cacheArcLengths=e},M.prototype.getPoints=function(){for(var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:5,e=[],r=0;r<=t;r++)e.push(this.getPoint(r/t));return e};function A(){this.curves=[]}A.prototype.getPoint=function(t){for(var e=t*this.getLength(),r=this.getCurveLengths(),n=0;n<r.length;){if(r[n]>=e){var i=r[n]-e,o=this.curves[n],a=o.getLength();return o.getPointAt(0===a?0:1-i/a)}n++}return null},A.prototype.getLength=function(){var t=this.getCurveLengths();return t[t.length-1]},A.prototype.getCurveLengths=function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var t=[],e=0,r=0,n=this.curves.length;r<n;r++)e+=this.curves[r].getLength(),t.push(e);return this.cacheLengths=t},A.prototype.getLength=function(){var t=this.getCurveLengths();return t[t.length-1]},A.prototype.getPoints=function(){for(var t=[],e=void 0,r=0,n=this.curves;r<n.length;r++)for(var i=n[r].getPoints(1),o=0;o<i.length;o++){var a=i[o];e&&e.equals(a)||(t.push(a),e=a)}return t};function X(){A.call(this),this.currentPoint=new ht.Math.Vector2,this.holes=[]}(X.prototype=Object.create(A.prototype)).moveTo=function(t,e){return this.currentPoint.set(t,e),this},X.prototype.lineTo=function(t,e){var r=new M(this.currentPoint.clone(),new ht.Math.Vector2(t,e));return this.curves.push(r),this.currentPoint.set(t,e),this},X.prototype.extractPoints=function(t){return{shape:this.getPoints(t),holes:this.getPointsHoles(t)}},X.prototype.getPointsHoles=function(t){for(var e=[],r=0,n=this.holes.length;r<n;r++)e[r]=this.holes[r].getPoints(t);return e},X.prototype.getPoints=function(){for(var t=[],e=void 0,r=0,n=this.curves;r<n.length;r++)for(var i=n[r].getPoints(1),o=0;o<i.length;o++){var a=i[o];e&&e.equals(a)||(t.push(a),e=a)}return t};function Z(t,e){this.groups=[],this.attributes={},this.parameters={shapes:t,options:e};for(var r=[],n=[],i=0,o=(t=Array.isArray(t)?t:[t]).length;i<o;i++){var a=t[i];this.addShape(a,e,r,n)}this.setAttribute("position",new k(r,3)),this.setAttribute("uv",new k(n,2)),this.computeVertexNormals()}Z.prototype.setAttribute=function(t,e){return this.attributes[t]=e,this},Z.prototype.getAttribute=function(t){return this.attributes[t]},Z.prototype.addShape=function(t,e,c,r){var n=[],p=void 0!==e.steps?e.steps:1,i=void 0!==e.depth?e.depth:100,d={generateTopUV:function(t,e,r,n,i){var o=e[3*r],a=e[3*r+1],s=e[3*n],r=e[3*n+1],n=e[3*i],i=e[3*i+1];return[new ht.Math.Vector2(o,a),new ht.Math.Vector2(s,r),new ht.Math.Vector2(n,i)]},generateSideWallUV:function(t,e,r,n,i,o){var a=e[3*r],s=e[3*r+1],h=e[3*r+2],u=e[3*n],l=e[3*n+1],c=e[3*n+2],p=e[3*i],d=e[3*i+1],r=e[3*i+2],n=e[3*o],i=e[3*o+1],o=e[3*o+2];return Math.abs(s-l)<.01?[new ht.Math.Vector2(a,1-h),new ht.Math.Vector2(u,1-c),new ht.Math.Vector2(p,1-r),new ht.Math.Vector2(n,1-o)]:[new ht.Math.Vector2(s,1-h),new ht.Math.Vector2(l,1-c),new ht.Math.Vector2(d,1-r),new ht.Math.Vector2(i,1-o)]}},v=0,t=t.extractPoints(12),o=t.shape,a=t.holes;if(!this.isClockWise(o))for(var o=o.reverse(),s=0,h=a.length;s<h;s++){var u=a[s];this.isClockWise(u)&&(a[s]=u.reverse())}for(var l=this.triangulateShape(o,a),g=o,f=0,y=a.length;f<y;f++){var m=a[f];o=o.concat(m)}for(var x=o.length,b=l.length,w=[],_=0,M=g.length,A=M-1,P=_+1;_<M;_++,A++,P++)w[_]=this.getBevelVec(g[_],g[A=A===M?0:A],g[P=P===M?0:P]);for(var D=[],I=void 0,V=w.concat(),C=0,L=a.length;C<L;C++){for(var E=a[C],I=[],T=0,z=E.length,k=z-1,S=T+1;T<z;T++,k++,S++)k===z&&(k=0),S===z&&(S=0),I[T]=this.getBevelVec(E[T],E[k],E[S]);D.push(I),V=V.concat(I)}for(var N=0;N<x;N++){var B=o[N];n.push(B.x),n.push(B.y),n.push(0)}for(var F=1;F<=p;F++)for(var Y=0;Y<x;Y++){var j=o[Y];n.push(j.x),n.push(j.y),n.push(i/p*F)}for(var O=v-1;0<=O;O--){for(var R=O/v,U=0*Math.cos(R*Math.PI/2),H=0*Math.sin(R*Math.PI/2),Q=0,G=g.length;Q<G;Q++){var J=this.scalePt2(g[Q],w[Q],H);n.push(J.x),n.push(J.y),n.push(i+U)}for(var X=0,Z=a.length;X<Z;X++){var q=a[X];I=D[X];for(var W=0,K=q.length;W<K;W++){var $=this.scalePt2(q[W],I[W],H);n.push($.x),n.push($.y),n.push(i+U)}}}var tt=this;function et(t){c.push(n[3*t]),c.push(n[3*t+1]),c.push(n[3*t+2])}function rt(t){r.push(t.x),r.push(t.y)}!function(){function t(t,e,r){et(t),et(e),et(r);r=c.length/3,r=d.generateTopUV(tt,c,r-3,r-2,r-1);rt(r[0]),rt(r[1]),rt(r[2])}for(var e=c.length/3,r=0;r<b;r++){var n=l[r];t(n[2],n[1],n[0])}for(var i=0;i<b;i++){var o=l[i];t(o[0]+x*p,o[1]+x*p,o[2]+x*p)}tt.addGroup(e,c.length/3-e,0)}(),function(){function t(t,e){for(var r,n,i=t.length;0<=--i;){var o=i,a=i-1;a<0&&(a=t.length-1);for(var s=0,h=p+2*v;s<h;s++){var u=x*s,l=x*(s+1);r=e+a+u,n=e+a+l,l=e+o+l,et(e+o+u),et(r),et(l),et(r),et(n),et(l),l=c.length/3,rt((l=d.generateSideWallUV(tt,c,l-6,l-3,l-2,l-1))[0]),rt(l[1]),rt(l[3]),rt(l[1]),rt(l[2]),rt(l[3])}}}var e=c.length/3,r=0;t(g,r),r+=g.length;for(var n=0,i=a.length;n<i;n++){var o=a[n];t(o,r),r+=o.length}tt.addGroup(e,c.length/3-e,1)}()},Z.prototype.scalePt2=function(t,e,r){return e.clone().multiplyScalar(r).add(t)},Z.prototype.getBevelVec=function(t,e,r){var n=void 0,i=void 0,o=void 0,a=t.x-e.x,s=t.y-e.y,h=r.x-t.x,u=r.y-t.y,l=a*a+s*s;if(Math.abs(a*u-s*h)>Number.EPSILON){var c=Math.sqrt(l),p=Math.sqrt(h*h+u*u),d=e.x-s/c,c=e.y+a/c,p=((r.x-u/p-d)*u-(r.y+h/p-c)*h)/(a*u-s*h),p=(n=d+a*p-t.x)*n+(i=c+s*p-t.y)*i;if(p<=2)return new ht.Math.Vector2(n,i);o=Math.sqrt(p/2)}else{p=!1;a>Number.EPSILON?h>Number.EPSILON&&(p=!0):a<-Number.EPSILON?h<-Number.EPSILON&&(p=!0):Math.sign(s)===Math.sign(u)&&(p=!0),o=p?(n=-s,i=a,Math.sqrt(l)):(n=a,i=s,Math.sqrt(l/2))}return new ht.Math.Vector2(n/o,i/o)},Z.prototype.addGroup=function(t,e,r){this.groups.push({start:t,count:e,materialIndex:r})},Z.prototype.isClockWise=function(t){return function(t){for(var e=t.length,r=0,n=e-1,i=0;i<e;n=i++)r+=t[n].x*t[i].y-t[i].x*t[n].y;return.5*r}(t)<0},Z.prototype.triangulateShape=function(t,e){function r(t){var e=t.length;2<e&&t[e-1].equals(t[0])&&t.pop()}function n(t,e){for(var r=0;r<e.length;r++)t.push(e[r].x),t.push(e[r].y)}var i=[],o=[],a=[];r(t),n(i,t);var s=t.length;e.forEach(r);for(var h=0;h<e.length;h++)o.push(s),s+=e[h].length,n(i,e[h]);for(var u=this.triangulate(i,o),l=0;l<u.length;l+=3)a.push(u.slice(l,l+3));return a},Z.prototype.triangulate=function(t,e,r){function l(t,e,r,n,i){var o=void 0,a=void 0;if(i===0<function(t,e,r,n){for(var i=0,o=e,a=r-n;o<r;o+=n)i+=(t[a]-t[o])*(t[o+1]+t[a+1]),a=o;return i}(t,e,r,n))for(o=e;o<r;o+=n)a=s(o,t[o],t[o+1],a);else for(o=r-n;e<=o;o-=n)a=s(o,t[o],t[o+1],a);return a&&v(a,a.next)&&(w(a),a=a.next),a}function c(t,e){if(!t)return t;e=e||t;var r=t,n=void 0;do{if(n=!1,r.steiner||!v(r,r.next)&&0!==y(r.prev,r,r.next))r=r.next;else{if(w(r),(r=e=r.prev)===r.next)break;n=!0}}while(n||r!==e);return e}function p(t,e,r,n,i,o,a){if(t){!a&&o&&function(t,e,r,n){var i=t;for(;null===i.z&&(i.z=g(i.x,i.y,e,r,n)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next,i!==t;);i.prevZ.nextZ=null,i.prevZ=null,function(t){var e=void 0,r=void 0,n=void 0,i=void 0,o=void 0,a=void 0,s=void 0,h=void 0,u=1;do{for(r=t,o=t=null,a=0;r;){for(a++,n=r,e=s=0;e<u&&(s++,n=n.nextZ);e++);for(h=u;0<s||0<h&&n;)0!==s&&(0===h||!n||r.z<=n.z)?(r=(i=r).nextZ,s--):(n=(i=n).nextZ,h--),o?o.nextZ=i:t=i,i.prevZ=o,o=i;r=n}}while(o.nextZ=null,u*=2,1<a)}(i)}(t,n,i,o);for(var s,h,u=t;t.prev!==t.next;)if(s=t.prev,h=t.next,o?function(t,e,r,n){var i=t.prev,o=t,a=t.next;if(0<=y(i,o,a))return!1;var s=(i.x<o.x?i.x<a.x?i:a:o.x<a.x?o:a).x,h=(i.y<o.y?i.y<a.y?i:a:o.y<a.y?o:a).y,u=(i.x>o.x?i.x>a.x?i:a:o.x>a.x?o:a).x,l=(i.y>o.y?i.y>a.y?i:a:o.y>a.y?o:a).y,c=g(s,h,e,r,n),p=g(u,l,e,r,n),d=t.prevZ,v=t.nextZ;for(;d&&d.z>=c&&v&&v.z<=p;){if(d!==t.prev&&d!==t.next&&f(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=y(d.prev,d,d.next))return!1;if(d=d.prevZ,v!==t.prev&&v!==t.next&&f(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=y(v.prev,v,v.next))return!1;v=v.nextZ}for(;d&&d.z>=c;){if(d!==t.prev&&d!==t.next&&f(i.x,i.y,o.x,o.y,a.x,a.y,d.x,d.y)&&0<=y(d.prev,d,d.next))return!1;d=d.prevZ}for(;v&&v.z<=p;){if(v!==t.prev&&v!==t.next&&f(i.x,i.y,o.x,o.y,a.x,a.y,v.x,v.y)&&0<=y(v.prev,v,v.next))return!1;v=v.nextZ}return!0}(t,n,i,o):function(t){var e=t.prev,r=t,n=t.next;if(0<=y(e,r,n))return!1;var i=t.next.next;for(;i!==t.prev;){if(f(e.x,e.y,r.x,r.y,n.x,n.y,i.x,i.y)&&0<=y(i.prev,i,i.next))return!1;i=i.next}return!0}(t))e.push(s.i/r),e.push(t.i/r),e.push(h.i/r),w(t),t=h.next,u=h.next;else if((t=h)===u){a?1===a?p(t=function(t,e,r){var n=t;do{var i=n.prev,o=n.next.next}while(!v(i,o)&&m(i,n,n.next,o)&&x(i,o)&&x(o,i)&&(e.push(i.i/r),e.push(n.i/r),e.push(o.i/r),w(n),w(n.next),n=t=o),n=n.next,n!==t);return c(n)}(c(t),e,r),e,r,n,i,o,2):2===a&&function(t,e,r,n,i,o){var a=t;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&function(t,e){return t.next.i!==e.i&&t.prev.i!==e.i&&!function(t,e){var r=t;do{if(r.i!==t.i&&r.next.i!==t.i&&r.i!==e.i&&r.next.i!==e.i&&m(r,r.next,t,e))return!0}while(r=r.next,r!==t);return!1}(t,e)&&(x(t,e)&&x(e,t)&&function(t,e){var r=t,n=!1,i=(t.x+e.x)/2,o=(t.y+e.y)/2;for(;r.y>o!=r.next.y>o&&r.next.y!==r.y&&i<(r.next.x-r.x)*(o-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next,r!==t;);return n}(t,e)&&(y(t.prev,t,e.prev)||y(t,e.prev,e))||v(t,e)&&0<y(t.prev,t,t.next)&&0<y(e.prev,e,e.next))}(a,s)){var h=b(a,s);return a=c(a,a.next),h=c(h,h.next),p(a,e,r,n,i,o),p(h,e,r,n,i,o)}s=s.next}}while(a=a.next,a!==t)}(t,e,r,n,i,o):p(c(t),e,r,n,i,o,1);break}}}function n(t,e,r,n){for(var i,o,a=[],s=void 0,h=void 0,s=0,u=e.length;s<u;s++)(h=l(t,e[s]*n,s<u-1?e[s+1]*n:t.length,n,!1))===h.next&&(h.steiner=!0),a.push(function(t){var e=t,r=t;for(;(e.x<r.x||e.x===r.x&&e.y<r.y)&&(r=e),e=e.next,e!==t;);return r}(h));for(a.sort(d),s=0;s<a.length;s++)i=a[s],(o=function(t,e){var r=e,n=t.x,i=t.y,o=-1/0,a=void 0;do{if(i<=r.y&&i>=r.next.y&&r.next.y!==r.y){var s=r.x+(i-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=n&&o<s){if((o=s)===n){if(i===r.y)return r;if(i===r.next.y)return r.next}a=r.x<r.next.x?r:r.next}}}while(r=r.next,r!==e);if(!a)return null;if(n===o)return a;var h=a,u=a.x,l=a.y,c=1/0,p=void 0;r=a;for(;n>=r.x&&r.x>=u&&n!==r.x&&f(i<l?n:o,i,u,l,i<l?o:n,i,r.x,r.y)&&(p=Math.abs(i-r.y)/(n-r.x),x(r,t)&&(p<c||p===c&&(r.x>a.x||r.x===a.x&&function(t,e){return y(t.prev,t,e.prev)<0&&y(e.next,t,t.next)<0}(a,r)))&&(a=r,c=p)),r=r.next,r!==h;);return a}(i,o=r))&&(i=b(o,i),c(o,o.next),c(i,i.next)),r=c(r,r.next);return r}function d(t,e){return t.x-e.x}function g(t,e,r,n,i){return(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)*i)|t<<8))|t<<4))|t<<2))|t<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-n)*i)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function f(t,e,r,n,i,o,a,s){return 0<=(i-a)*(e-s)-(t-a)*(o-s)&&0<=(t-a)*(n-s)-(r-a)*(e-s)&&0<=(r-a)*(o-s)-(i-a)*(n-s)}function y(t,e,r){return(e.y-t.y)*(r.x-e.x)-(e.x-t.x)*(r.y-e.y)}function v(t,e){return t.x===e.x&&t.y===e.y}function m(t,e,r,n){var i=u(y(t,e,r)),o=u(y(t,e,n)),a=u(y(r,n,t)),s=u(y(r,n,e));return i!==o&&a!==s||(0===i&&h(t,r,e)||(0===o&&h(t,n,e)||(0===a&&h(r,t,n)||0===s&&h(r,e,n))))}function h(t,e,r){return e.x<=Math.max(t.x,r.x)&&e.x>=Math.min(t.x,r.x)&&e.y<=Math.max(t.y,r.y)&&e.y>=Math.min(t.y,r.y)}function u(t){return 0<t?1:t<0?-1:0}function x(t,e){return y(t.prev,t,t.next)<0?0<=y(t,e,t.next)&&0<=y(t,t.prev,e):y(t,e,t.prev)<0||y(t,t.next,e)<0}function b(t,e){var r=new a(t.i,t.x,t.y),n=new a(e.i,e.x,e.y),i=t.next,o=e.prev;return(t.next=e).prev=t,(r.next=i).prev=r,(n.next=r).prev=n,(o.next=n).prev=o,n}function s(t,e,r,n){r=new a(t,e,r);return n?(r.next=n.next,(r.prev=n).next.prev=r,n.next=r):(r.prev=r).next=r,r}function w(t){t.next.prev=t.prev,t.prev.next=t.next,t.prevZ&&(t.prevZ.nextZ=t.nextZ),t.nextZ&&(t.nextZ.prevZ=t.prevZ)}function a(t,e,r){this.i=t,this.x=e,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}r=r||2;var i=e&&e.length,o=i?e[0]*r:t.length,_=l(t,0,o,r,!0),M=[];if(!_||_.next===_.prev)return M;var A,P,D=void 0,I=void 0,V=void 0,C=void 0,L=void 0;if(i&&(_=n(t,e,_,r)),t.length>80*r){for(var D=V=t[0],I=C=t[1],E=r;E<o;E+=r)(A=t[E])<D&&(D=A),(P=t[E+1])<I&&(I=P),V<A&&(V=A),C<P&&(C=P);L=0!==(L=Math.max(V-D,C-I))?1/L:0}return p(_,M,r,D,I,L),M},Z.prototype.computeVertexNormals=function(){var t=this.getAttribute("position"),e=new ht.Math.Vector3;if(void 0!==t){var r=this.getAttribute("normal");void 0===r&&(r=new w(new Float32Array(t.length),3),this.setAttribute("normal",r));for(var n=new ht.Math.Vector3,i=new ht.Math.Vector3,o=new ht.Math.Vector3,a=new ht.Math.Vector3,s=new ht.Math.Vector3,h=0,u=t.count;h<u;h+=3)n.x=t[3*h],n.y=t[3*h+1],n.z=t[3*h+2],i.x=t[3*(h+1)],i.y=t[3*(h+1)+1],i.z=t[3*(h+1)+2],o.x=t[3*(h+2)],o.y=t[3*(h+2)+1],o.z=t[3*(h+2)+2],a.subVectors(o,i),s.subVectors(n,i),a.cross(s),r[3*h]=a.x,r[3*h+1]=a.y,r[3*h+2]=a.z,r[3*(h+1)]=a.x,r[3*(h+1)+1]=a.y,r[3*(h+1)+2]=a.z,r[3*(h+2)]=a.x,r[3*(h+2)+1]=a.y,r[3*(h+2)+2]=a.z;this.normalizeNormals(e)}},Z.prototype.normalizeNormals=function(t){for(var e=this.attributes.normal,r=0,n=e.length/3;r<n;r++)t.x=e[3*r],t.y=e[3*r+1],t.z=e[3*r+2],t.normalize(),e[3*r]=t.x,e[3*r+1]=t.y,e[3*r+2]=t.z};function q(){}function W(t){for(var e,r={},n=new S,i=0;i<t.length;++i){var o,a=t[i];for(o in a.attributes)a.attributes.hasOwnProperty(o)&&(void 0===r[o]&&(r[o]=[]),r[o].push(a.attributes[o]))}for(e in r){var s=function(t){for(var e=void 0,r=0,n=0;n<t.length;++n){var i=t[n];void 0===e&&(e=i.array.constructor),r+=i.array.length}for(var o=new e(r),a=0,s=0;s<t.length;++s)o.set(t[s].array,a),a+=t[s].array.length;return new w(o)}(r[e]);n.setAttribute(e,s)}return n}q.prototype.parse=function(t){var m="",x=0,b=0,w=0,_=new ht.Math.Vector3,M=new ht.Math.Vector3,A=new ht.Math.Vector2,P=[];return function(t){var e=0,r=0,n=0,i=new ht.Math.Matrix3,o=t.attributes.position,a=t.attributes.normal,s=t.attributes.uv;if(m+="o test\n",void 0!==o)for(var h=0,u=o.array.length/3;h<u;h++,e++)_.x=o.array[3*h],_.y=o.array[3*h+1],_.z=o.array[3*h+2],m+="v "+_.x+" "+_.y+" "+_.z+"\n";if(void 0!==s)for(var l=0,c=s.array.length/2;l<c;l++,n++)A.x=s.array[2*l],A.y=s.array[2*l+1],m+="vt "+A.x+" "+A.y+"\n";if(void 0!==a)for(var p=0,d=a.array.length/3;p<d;p++,r++)M.x=a.array[3*p],M.y=a.array[3*p+1],M.z=a.array[3*p+2],M.applyMatrix3(i).normalize(),m+="vn "+M.x+" "+M.y+" "+M.z+"\n";for(var v=0,g=o.array.length/3;v<g;v+=3){for(var f=0;f<3;f++){var y=v+f+1;P[f]=x+y+(a||s?"/"+(s?b+y:"")+(a?"/"+(w+y):""):"")}m+="f "+P.join(" ")+"\n"}x+=e,b+=n,w+=r}(t),m};t(P,[{key:"init",value:function(u,l){var c=this;p()&&u&&u.scene&&ht.map._graph3dView.deserialize(u.scene,function(t,e,r,n){t&&(c._property=t.scene);var i=new ht.Node;i.a({type:"hostForScene"}),n&&n.each(function(t){c._sceneNodes.push(t),t.getHost()||t.setHost(i)});var o=u.lngLat,a={x:0,y:0};o&&(a=(new ht.map.HTGisConverter).getXY(o,ht.mapbox.center));var s=u.rotation||[0,0,0],h=u.scale||[1,1,1],t=u.height||0;i.setRotation3d(s[0],s[1],s[2]),i.setScale3d(h[0],h[1],h[2]),i.setPosition3d(a.x,t,a.y),c._sceneNodes.push(i),c._center=o,c._worldCoordinate=[a.x,t,a.y],l&&l(r,n)})}},{key:"remove",value:function(){this._sceneNodes.forEach(function(t){ht.map._graph3dView.dm().remove(t)}),this._sceneNodes.length=0}},{key:"encodeObjFile",value:function(n,v){p()&&Array.isArray(n)&&n.length&&function(){for(var t=new _,d=new m,e=0;e<n.length;e++){var r=n[e];t.load(r,function(t){for(var e=0;e<t.length;e++){for(var r=t[e].attributes,n=r.position.array,i=[],o=0;o<n.length;o+=9)i.push(-n[o],n[o+1],-n[o+2]),i.push(-n[o+3],n[o+4],-n[o+5]),i.push(-n[o+6],n[o+7],-n[o+8]);var a={vs:i};if(v&&v.uv&&r.uv){for(var s=r.uv.array,h=[],u=0;u<s.length;u++)u%2==0?h.push(s[u]):h.push(1-s[u]);a.uv=h}if(v&&v.ns&&r.normal){for(var l=r.normal.array,c=[],p=0;p<l.length;p++)c.push(l[p]);a.ns=c}d.downLoadData(a)}})}}()}},{key:"convertGeoToObj",value:function(t,U,H,Q){var G=this,e=4<arguments.length&&void 0!==arguments[4]?arguments[4]:100;p()&&(this.limit=e,ht.Default.xhrLoad(t,function(t){for(var e,r,n,i=new J,o=[],a=ht.Default.parse(t).features,s=0;s<a.length;s++){if(void 0!==H&&void 0!==Q){if(s<H)continue;if(Q<s)continue}var h=a[s].geometry.coordinates;if(h){var u=a[s].properties.Elevation||a[s].properties.height;void 0===u&&(u=10);for(var l=0;l<h.length;l++)for(var c=h[l],p=0;p<c.length;p++){var d=c[p],v=new X;if(G.checkBounds(U,d[0])){for(var g=0;g<d.length;g++){var f=i.getXY([d[g][0],d[g][1]],U);0===g?v.moveTo(f.x,-f.y):v.lineTo(f.x,-f.y)}for(var y=new Z(v,{steps:1,depth:u}),m=y.attributes.position.array,x=0,b=[],w=new Map,_=0;_<m.length;_+=3)if(0===m[_+2])if(0===_){var M=new ht.Math.Vector3(m[_],m[_+1],m[_+2]);b.push({vector:M,dis:0,indexArr:[_]}),w.set(_,M)}else{for(var A=new ht.Math.Vector3(m[_],m[_+1],m[_+2]),P=!0,D=0;D<b.length;D++){var I=b[D],V=I.vector;if(A.distanceTo(V)<1e-4){I.indexArr.push(_),w.set(_,A),P=!1;break}}P&&(x+=b[b.length-1].vector.distanceTo(A),b.push({vector:A,dis:x/10,indexArr:[_]}))}b[b.length-1].dis=Math.round(b[b.length-1].dis);for(var C=[],L=0;L<m.length;L+=3)if(0!==m[L+2])for(var E=new ht.Math.Vector3(m[L],m[L+1],0),T=0;T<b.length;T++){var z=b[T],k=z.vector;E.distanceTo(k)<1e-4&&C.push({dis:z.dis,index:L})}for(var S=0;S<b.length;S++)for(var N=b[S],B=N.dis,F=N.indexArr,Y=0;Y<F.length;Y++)y.attributes.uv.array[2*F[Y]/3]=B,y.attributes.uv.array[2*F[Y]/3+1]=0;for(var j=0;j<C.length;j++){var O=C[j],R=O.dis,O=O.index;y.attributes.uv.array[2*O/3]=R,y.attributes.uv.array[2*O/3+1]=1}o.push(y)}}}}o.length&&(t=function(t){var e=W(t);e.groups=[];for(var r=0,n=0;n<t.length;n++){var i=t[n].groups;i&&0!==i.length||(i=[{start:0,count:t[n].attributes.position.count,materialIndex:n}]);for(var o=0;o<i.length;o++){var a=i[o];a.start+=r,e.groups.push(a)}r+=t[n].attributes.position.count}return e}(o),t=(new q).parse(t),e=new Blob([t],{type:"application/octet-stream"}),r="file.obj",(n=document.createElement("a")).style.display="none",document.body.appendChild(n),n.href=URL.createObjectURL(e),n.download=r,n.click(),document.body.removeChild(n))}))}},{key:"checkBounds",value:function(t,e){var r=e[0],e=e[1];return r<t[0]+this.limit&&r>t[0]-this.limit&&e<t[1]+this.limit&&e>t[1]-this.limit}},{key:"loadHtmb",value:function(t,r){var e,n=this;p()&&((e=new XMLHttpRequest).responseType="arraybuffer",e.open("GET",t,!0),e.addEventListener("load",function(t){var e=this.response;200===this.status||0===this.status?r((e=e,n.parse(e))):console.warn("fail to load htmb file")},!1),e.send(null))}},{key:"setPath",value:function(t){return this.path=t,this}},{key:"parse",value:function(t){return(new v).parse(t)}},{key:"createRoad",value:function(s){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:10,h=arguments[2],e=3<arguments.length&&void 0!==arguments[3]?arguments[3]:"assets/ht_mapbox_road.png",r=4<arguments.length&&void 0!==arguments[4]?arguments[4]:"attribute vec3 vs;\nattribute vec2 uv;\nattribute vec3 a_color;\n\nuniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\n\nvarying vec3 v_color;\nvarying vec2 vUv;\n\nvoid main(void) {\n    v_color = a_color;\n    vUv = vec2(uv);\n    gl_Position = uPMatrix * uMVMatrix * vec4(vs, 1.0);\n}\n",n=5<arguments.length&&void 0!==arguments[5]?arguments[5]:"varying vec3 v_color;\n\nuniform sampler2D image0;\nvarying vec2 vUv;\n\nvoid main(void) {\n    vec4 image0Color = texture2D(image0, vUv);\n    //gl_FragColor = vec4(mix(v_color, texture2D(image0, vUv).rgb, 0.5).rgb, 1.0);\n    gl_FragColor = vec4(v_color * max(image0Color.r, 0.3), 1.0);\n}\n";if(p())if(ht.Default.setShader){if(ht.Default.setShader("ht_mapbox_road_shader",r,n),Array.isArray(s)&&!(s.length<2)){var i=[];!function(){t:for(var t=0;t<s.length;t++){for(var e=s[t],r=0;r<i.length;r++){var n=i[r];if(Math.abs(e.x-n.x)<1e-4&&Math.abs(e.z-n.z)<1e-4)continue t}i.push(s[t])}}(),s=i;var u=[];!function(){if(h)if(Array.isArray(h)){for(var t=0;t<h.length;t++){var e=ht.Default.toColorData(h[t]);u.push(e[0]/255,e[1]/255,e[2]/255)}for(var r=0;r<h.length;r++){var n=ht.Default.toColorData(h[r]);u.push(n[0]/255,n[1]/255,n[2]/255)}}else for(var i=ht.Default.toColorData(h),o=0;o<2*s.length;o++)u.push(i[0]/255,i[1]/255,i[2]/255);else for(var a=0;a<2*s.length;a++)u.push(0,1,1)}();var n=new f,o=[];s.forEach(function(t){o.push(t.x,t.y,t.z)});var a,l,t=function(t){var e=t.up,r=t.down,t=[];t=(t=t.concat(r)).concat(e);for(var n=r.length,i=[],o=0;o<n/3-1;o++)i.push(o),i.push(o+1),i.push(o+n/3+1),i.push(o),i.push(o+n/3+1),i.push(o+n/3);for(var a=[],s=0;s<n/3;s++)a.push(s/(n/3-1)),a.push(0);for(var h=0;h<n/3;h++)a.push(h/(n/3-1)),a.push(1);return{vs:t,is:i,uv:a}}(n.getPerpendicularPointsForStraightRoad(o,t));return a=t,(l=new ht.Node).s({"3d.selectable":!1,"shape3d.reverse.flip":!0,shape3d:"custom","material.shader":"ht_mapbox_road_shader","material.image0":e,"geometry.vs":a.vs,"geometry.uv":a.uv,"geometry.is":a.is,"geometry.a_color":["float32",3,u]}),l.setSize3d(1,1,1),l}}else console.warn("please use ht-7.5.0 or higher")}},{key:"runRoadAnimation",value:function(a){var r,n,s,i=this;p()&&a&&a.length&&(r=0,n=Date.now(),s=[],a.forEach(function(t){t=t.s("geometry.uv");s.push(t)}),function t(){i._animationId=requestAnimationFrame(t);var e=Date.now();(function(t){for(var e=0;e<a.length;e++){for(var r=a[e],n=s[e],i=[],o=0;o<n.length;o++)o%2==0?i.push(n[o]+t):i.push(n[o]);r.s("geometry.uv",i)}})(r+=.01*(1+(e-n)/1e3)),n=e}())}},{key:"removeRoadAnimation",value:function(){null!==this._animationId&&cancelAnimationFrame(this._animationId)}}]),t=P;function P(t,e){r(this,P),this._sceneNodes=[],this._center=null,this._worldCoordinate=null,this._animationId=null,t&&this.init(t,e)}u={HTGisConverter:J,HTMovingNode:o,Map:s,Node:u,Scene:t};var D=null,I=null,V=null,C=null,L=null,E=null;function T(t){if(E){var e=D.getDataInfoAt(t);if(e){if(e.data instanceof ht.Points){var r=D.dm().getDataByTag("instructions");if(V){var n=e.data.s("createPointsIndex"),t=V[n][e.part];if(t){e=I.getConvert().getXY([t.lng,t.lat],C);if(r){if(r.a("billboardPos")==e)return;D.dm().remove(r)}t.instructions||(t.instructions="");var i=new ht.Node;i.s({shape3d:"billboard","shape3d.image":L,autorotate:!0,fixSizeOnScreen:-1}),i.a({billboardPos:e,pointsColor:["#00ff66","#ffffbf","#f46d43"][n],titleText:t.instructions,contentText:"当前值："+t.value}),i.setAnchor3d(0,0,1),i.setRenderLayer("top"),i.p3(e.x,0,e.y),i.setTag("instructions"),D.dm().add(i)}}}}else{i=D.dm().getDataByTag("instructions");i&&D.dm().remove(i)}}}var z=null,B=null,F=null,Y=null,j=null,O=null,R=null;function U(t){t=t.target.getZoom();j.size=j.size+5*(R-t),R=t,Y&&(z.deleteTexture(Y),(t=Y.getContext("2d")).clearRect(0,0,Y.width,Y.height),Q(t,O,j,z,B,F),z.redraw())}function H(t,e){var r=document.createElement("canvas");return r.width=t,r.height=e,r}function Q(e,t,n,r,i,o){var a=function(t){var e=t/2,r=t+e,n=document.createElement("canvas");n.width=2*r,n.height=2*r;var i=n.getContext("2d");return i.shadowBlur=e,i.shadowColor="black",i.shadowOffsetX=i.shadowOffsetY=1e3,i.beginPath(),i.arc(r-1e3,r-1e3,t,0,2*Math.PI,!0),i.closePath(),i.fill(),n}(n.size),s=a.width/2,h=a.height/2,u=r.dm().getDataByTag("heatmapNode"),r=u.s3(),u=u.p3(),l=u[0]-r[0]/2,c=u[0]+r[0]/2,p=u[2]-r[0]/2,d=u[2]+r[0]/2;t.forEach(function(t,e){var r=i.getConvert().getXY([t.lng,t.lat],o);t.x=(r.x-l)/(c-l),t.y=(r.y-p)/(d-p)});var v,g,f={};for(v in t.forEach(function(t,e){var r=Math.min(1,t.value/n.max).toFixed(2);f[r]=f[r]||[],f[r].push(t)}),f)isNaN(v)||(g=f[v],e.beginPath(),e.globalAlpha=v,g.forEach(function(t){e.drawImage(a,t.x*Y.width-s,t.y*Y.height-h)}));r=new G,t=e.getImageData(0,0,e.canvas.width,e.canvas.height);!function(t,e,r){var n=r.max,i=r.min,o=n-i,n=r.range||null,a=0,s=1024;n&&2===n.length&&(a=(n[0]-i)/o*1024);n&&2===n.length&&(s=(n[1]-i)/o*1024);for(var h,u=r.maxOpacity||.8,l=3,c=t.length;l<c;l+=4)h=4*t[l],t[l]/256>u&&(t[l]=256*u),h&&a<=h&&h<=s?(t[l-3]=e[h],t[l-2]=e[1+h],t[l-1]=e[2+h]):t[l]=0}(t.data,r.getImageData(),n),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.putImageData(t,0,0)}function G(t){this.gradient=(t=t||{}).gradient||{.25:"rgba(0, 0, 255, 1)",.55:"rgba(0, 255, 0, 1)",.85:"rgba(255, 255, 0, 1)",1:"rgba(255, 0, 0, 1)"},this.maxSize=t.maxSize||35,this.minSize=t.minSize||0,this.max=t.max||100,this.min=t.min||0,this.initPalette()}G.prototype.setMax=function(t){this.max=t||100},G.prototype.setMin=function(t){this.min=t||0},G.prototype.setMaxSize=function(t){this.maxSize=t||35},G.prototype.setMinSize=function(t){this.minSize=t||0},G.prototype.initPalette=function(){var t,e=this.gradient,r=new H(256,1),r=this.paletteCtx=r.getContext("2d"),n=r.createLinearGradient(0,0,256,1);for(t in e)n.addColorStop(parseFloat(t),e[t]);r.fillStyle=n,r.fillRect(0,0,256,1)},G.prototype.getColor=function(t){t=this.getImageData(t);return"rgba("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]/256+")"},G.prototype.getImageData=function(t){var e=this.paletteCtx.getImageData(0,0,256,1).data;if(void 0===t)return e;var r=this.max,n=this.min;(t=r<t?r:t)<n&&(t=n);n=4*Math.floor((t-n)/(r-n)*255);return[e[n],e[1+n],e[2+n],e[3+n]]},G.prototype.getSize=function(t){var e=this.max,r=this.min,n=this.maxSize,i=this.minSize;return i+((t=(t=e<t?e:t)<r?r:t)-r)/(e-r)*(n-i)},G.prototype.getLegend=function(t){var e,r=this.gradient,n=t.width||20,i=t.height||180,o=new H(n,i),t=o.getContext("2d"),a=t.createLinearGradient(0,i,0,0);for(e in r)a.addColorStop(parseFloat(e),r[e]);return t.fillStyle=a,t.fillRect(0,0,n,i),o};var K=null,$=null,tt=null,et=null,rt=null,nt=null,it=null;function ot(t,e,r,n,i,o,a){var s=null,h=null,u=0,l=0,c=0,p=1,d=0,v=0,g=0;Array.isArray(n)&&(s=(s=(s=n[0].split("(")[1]||"").split(")")[0]||"").split(","),h=(h=(h=n[1].split("(")[1]||"").split(")")[0]||"").split(","),u=(s[0]||0)/255,l=(s[1]||0)/255,c=(s[2]||0)/255,p=s[3]||1,d=(h[0]||0)/255,v=(h[1]||0)/255,g=(h[2]||0)/255,h[3]);for(var f=[0,1,0],y=[],m=[1,1],x=[u,l,c,p],b=e;b<=r;b++){var w=Math.PI/180*b;f.push(Math.cos(w),1,Math.sin(w)),y.push(b-e,0,b-e+1),m.push(Math.cos(w),Math.sin(w)),Array.isArray(n)&&x.push(u,l,c,p)}for(var _=e;_<=r;_++){var M=Math.PI/180*_;f.push(Math.cos(M),0,Math.sin(M)),_!=r&&y.push(_-e+2+(r-e),_-e+3+(r-e),_-e+1,_-e+1,_-e+3+(r-e),_-e+2),m.push(Math.cos(M),Math.sin(M)),Array.isArray(n)&&x.push(d,v,g,g)}if(f.push(0,0,0),y.push(0,1,r-e+2,0,r-e+2,f.length/3-1,0,f.length/3-1,f.length/3-2,0,f.length/3-2,r-e+1),m.push(1,1),Array.isArray(n)&&x.push(d,v,g,g),"string"==typeof n){var A=new ht.Node;return A.s({shape3d:{vs:f,is:y,uv:m},"shape3d.color":n,"shape3d.reverse.flip":!0,"shape3d.opacity":i}),A.s3(o),A.p3(a),t.dm().add(A),A}if(Array.isArray(n)){A=new ht.Node;return A.s3(o),A.p3(a),A.s({shape3d:"custom","material.shader":"myShader","geometry.vs":f,"geometry.is":y,"geometry.uv":m,"geometry.a_color":["float32",4,x],"shape3d.transparent":!0}),t.dm().add(A),A}}function at(t,e,r,n,i,o,a,s){var h=null,u=null,l=0,c=0,p=0,d=1,v=0,g=0,f=0,y=1;Array.isArray(n)&&(h=(h=(h=n[0].split("(")[1]||"").split(")")[0]||"").split(","),u=(u=(u=n[1].split("(")[1]||"").split(")")[0]||"").split(","),l=(h[0]||0)/255,c=(h[1]||0)/255,p=(h[2]||0)/255,d=h[3]||1,v=(u[0]||0)/255,g=(u[1]||0)/255,f=(u[2]||0)/255,y=u[3]||1);for(var m=[],x=[],b=[],w=[v,g,f,f],_=e;_<=r;_++){var M=Math.PI/180*_;m.push(Math.cos(M),1,Math.sin(M),s*Math.cos(M),1,s*Math.sin(M)),b.push(1,1,1,1),Array.isArray(n)&&w.push(l,c,p,d,l,c,p,d)}for(var A=e;A<r;A++)x.push(2*(A-e),2*(A-e)+1,2*(A-e)+3,2*(A-e),2*(A-e)+3,2*(A-e)+2);for(var P=e;P<=r;P++){var D=Math.PI/180*P;m.push(Math.cos(D),0,Math.sin(D),s*Math.cos(D),0,s*Math.sin(D)),b.push(1,1,1,1),Array.isArray(n)&&w.push(v,g,f,y,v,g,f,y)}for(var I=e;I<r;I++)x.push(2*(I-e)+2+2*(r-e),2*(I-e)+4+2*(r-e),2*(I-e),2*(I-e),2*(I-e)+4+2*(r-e),2*(I-e)+2,2*(I-e)+3+2*(r-e),2*(I-e)+5+2*(r-e),2*(I-e)+1,2*(I-e)+1,2*(I-e)+5+2*(r-e),2*(I-e)+3);if(x.push(2+2*(r-e),3+2*(r-e),0,0,3+2*(r-e),1,m.length/3-1,m.length/3-2,1+2*(r-e),1+2*(r-e),m.length/3-2,2*(r-e)),"string"==typeof n){var V=new ht.Node;return V.s({shape3d:{vs:m,is:x,uv:b},"shape3d.color":n,"shape3d.reverse.flip":!0,"shape3d.opacity":i}),V.s3(o),V.p3(a),t.dm().add(V),V}if(Array.isArray(n)){V=new ht.Node;return V.s3(o),V.p3(a),V.s({shape3d:"custom","material.shader":"myShader","geometry.vs":m,"geometry.is":x,"geometry.uv":b,"geometry.a_color":["float32",4,w],"shape3d.transparent":!0}),t.dm().add(V),V}}function st(t){var e,r,n,i;it&&((r=K.getDataInfoAt(t))?(e=K.dm().getDataByTag("instructions"),rt&&(n=r.data.s("pieDataIndex"),t=r.data.s("valueDataIndex"),(r=rt[n])&&(n=$.getConvert().getXY([r.lng,r.lat],tt),e&&K.dm().remove(e),r.instructions||(r.instructions=""),(i=new ht.Node).s({shape3d:"billboard","shape3d.image":et,autorotate:!0,fixSizeOnScreen:-1}),i.a({pointsColor:nt[t],titleText:r.instructions,contentText:"当前值："+r.value[t]}),i.setAnchor3d(0,0,1),i.setRenderLayer("top"),i.p3(n.x,0,n.y),i.setTag("instructions"),K.dm().add(i)))):(i=K.dm().getDataByTag("instructions"))&&K.dm().remove(i))}var ut=[];function lt(t,e,r){this._g3d=t,this._origin=e,this._speed=r}ht.Default.def(lt,Object,{_shapes:[],_animateId:null,loadData:function(t){var e=new ht.map.HTGisConverter,r=[],n=new Set;t.forEach(function(t){void 0!==t.num&&(n.has(t.num)?r[t.num].push(t):(r[t.num]=[],r[t.num].push(t),n.add(t.num)))});for(var i=0;i<r.length;i++){for(var o=[],a=[],s=0,h=0;h<r[i].length;h++){var u=e.getXY([r[i][h].lng,r[i][h].lat],this._origin),u={x:u.x,y:u.y,e:0};o.push(u),0===h?a.push(1):a.push(2)}for(var l,c,h=0;h<o.length;h++)h%3==0&&o[h+5]&&(l=new ht.Math.Vector3(o[h],o[h+1],o[h+2]),c=new ht.Math.Vector3(o[h+3],o[h+4],o[h+5]),s+=l.distanceTo(c));var p=new ht.Shape;p.s({shape3d:"cylinder","shape3d.image":"ef98e140-d010-11eb-993b-e31c161dd796.json","shape3d.reverse.flip":!0,"shape3d.side":2,"shape3d.uv.scale":[1,1],"shape3d.top.visible":!1,"shape3d.bottom.visible":!1,"shape3d.resolution":20}),p.setThickness(100),p.setPoints(o),p.setSegments(a),p.a("num",0),p.a("limit",s),this._shapes.push(p),this._g3d.dm().add(p)}this.animate()},setSpeed:function(t){this._speed=t},animate:function(){this._animateId=requestAnimationFrame(function(){this.animate()}.bind(this)),this._shapes.forEach(function(t){t.a("num")>t.a("limit")?t.a("num",this._speed):t.a("num",t.a("num")+this._speed),t.s("shape3d.uv.offset",[t.a("num"),0])}.bind(this))},destroy:function(){this._animateId&&cancelAnimationFrame(this._animateId),this._shapes.length&&(this._shapes.forEach(function(t){this._g3d.dm().remove(t)}.bind(this)),this._shapes.length=0)}});function ct(t){this._node=t}ht.Default.def(ct,Object,{_beforeDirection:new ht.Math.Vector3(1,0,0),_currDirection:null,_currentPos:[],_currentPosCopy:[],_destinationPos:[],_destinationPosCopy:[],_movingLoop:!1,_stepLimit:1,setSpeed:function(t){1<=t&&(this._stepLimit=t)},setPos:function(t,e){if(!(t instanceof Array&&e instanceof Array))throw new Error("MovingNode setPos error");this._currentPos=t;for(var r=0;r<e.length;r++){var n=e[r][0],i=e[r][1],o=e[r][2];if(0===r){var a=this._currentPos[0],s=this._currentPos[1],h=this._currentPos[2],u=new ht.Math.Vector3(a,s,h),l=new ht.Math.Vector3(n,i,o).distanceTo(u);if(l>this._stepLimit)for(var c=(n-a)/(m=Math.ceil(l/this._stepLimit)),p=(i-s)/m,d=(o-h)/m,v=1;v<=m;v++)this._destinationPos.push([a+v*c,s+v*p,h+v*d]);else this._destinationPos.push([n,i,o])}else{var g=e[r-1][0],f=e[r-1][1],y=e[r-1][2],u=new ht.Math.Vector3(g,f,y),l=new ht.Math.Vector3(n,i,o).distanceTo(u);if(l>this._stepLimit)for(var m,c=(n-g)/(m=Math.ceil(l/this._stepLimit)),p=(i-f)/m,d=(o-y)/m,v=1;v<=m;v++)this._destinationPos.push([g+v*c,f+v*p,y+v*d]);else this._destinationPos.push([n,i,o])}}this._movingLoop&&(this._currentPosCopy=this._currentPos.slice(),this._destinationPosCopy=this._destinationPos.slice())},setPosToCurrent:function(){this._currentPos&&this._currentPos.length&&this._node.setPosition3d(this._currentPos[0],this._currentPos[1],this._currentPos[2]),this._destinationPos.length&&this.rotateToNextPos()},rotateToNextPos:function(){var t=new ht.Math.Vector3(this._currentPos[0],this._currentPos[1],this._currentPos[2]),e=new ht.Math.Vector3(this._destinationPos[0][0],this._destinationPos[0][1],this._destinationPos[0][2]);this._currDirection=new ht.Math.Vector3,this._currDirection.subVectors(e,t).setLength(1),this._currDirection.x.toFixed(4)===this._beforeDirection.x.toFixed(4)&&this._currDirection.z.toFixed(4)===this._beforeDirection.z.toFixed(4)||(t=this._beforeDirection.angleTo(this._currDirection),0<=this._currDirection.x*this._beforeDirection.x&&0<=this._currDirection.z*this._beforeDirection.z?0<this._beforeDirection.x||0<this._currDirection.x?this._beforeDirection.z<=this._currDirection.z?this.rotateNodeY(!0,t):this.rotateNodeY(!1,t):(this._beforeDirection.x<0||this._currDirection.x<0)&&(this._beforeDirection.z<=this._currDirection.z?this.rotateNodeY(!1,t):this.rotateNodeY(!0,t)):this._currDirection.x*this._beforeDirection.x*this._currDirection.z*this._beforeDirection.z<=0?0<=this._currDirection.z?0<=this._beforeDirection.x?this.rotateNodeY(!0,t):this.rotateNodeY(!1,t):0<=this._beforeDirection.x?this.rotateNodeY(!1,t):this.rotateNodeY(!0,t):this._currDirection.x*this._beforeDirection.x<=0&&this._currDirection.z*this._beforeDirection.z<=0&&(0<=this._currDirection.x*this._currDirection.z?Math.abs(this._currDirection.z)>=Math.abs(this._beforeDirection.z)?this.rotateNodeY(!1,t):this.rotateNodeY(!0,t):Math.abs(this._currDirection.z)>=Math.abs(this._beforeDirection.z)?this.rotateNodeY(!0,t):this.rotateNodeY(!1,t)),this._beforeDirection=this._currDirection.clone())},rotateNodeY:function(t,e){t?this._node.setRotationY(this._node.getRotationY()-e):this._node.setRotationY(this._node.getRotationY()+e)},moving:function(){if(this._currentPos!==this._destinationPos[0]){if(this._currentPos=this._destinationPos[0],this._destinationPos.shift(),this.setPosToCurrent(),0===this._destinationPos.length){if(!this._movingLoop)return!1;this._currentPos=this._currentPosCopy.slice(),this._destinationPos=this._destinationPosCopy.slice(),this.setPosToCurrent()}return!0}}});function pt(t,e,r){this._g3d=t,this._origin=e,this._map=r,this._convert=new ht.map.HTGisConverter}ht.Default.def(pt,Object,{_convert:null,_car:null,_animateId:null,loadData:function(t){for(var e=[],r=[],n=[],i=(t=t[0]).data,o=0;o<i.length;o++){var a=this._convert.getXY([i[o].lng,i[o].lat],this._origin);0===o?(n.push(i[o].lng,i[o].lat),e.push(a.x,0,a.y)):r.push([a.x,0,a.y])}var s=new ht.Node;s.s({shape3d:t.modelPath}),s.setScale3d(t.scale,t.scale,t.scale),this._g3d.dm().add(s),this._car=new ct(s),this._car.setSpeed(t.speed),this._car._movingLoop=!0,this._car.setPos(e,r),this._map.setPitch(60),this._map.flyTo({zoom:16,center:n,bearing:0}),this.animate()},animate:function(){var t;this._animateId=requestAnimationFrame(function(){this.animate()}.bind(this)),this._car.moving(),this._car._currentPos&&this._car._currentPos.length&&(t=this._convert.getLngLat({x:this._car._currentPos[0],y:this._car._currentPos[2]},this._origin),this._map.flyTo({zoom:18,center:t,bearing:0,easing:function(t){return t*(2-t)}}))},destroy:function(){this._animateId&&(cancelAnimationFrame(this._animateId),this._animateId=null),this._car&&this._car.node&&(this._g3d.dm().remove(this._car.node),this._car=null)}});t={createHistogramOnMap:function(n){var i=["rgba(69,117,180,0.5)","rgba(116,173,209,0.5)","rgba(255,255,191,0.5)","rgba(253,174,97,0.5)"];n.colorStyleArr&&4==n.colorStyleArr.length&&(i=n.colorStyleArr);var t=[400,800,1200,1600];n.intervalStyleArr&&4==n.intervalStyleArr.length&&(t=n.intervalStyleArr);for(var e=new Array,r=0;r<t.length;r++)e[r]=new Array;for(var o=0;o<n.posInfoArr.length;o++)for(var a=n.posInfoArr[o],s=0;s<t.length;s++)if(0==s){if(a.value<=t[s]&&0<=a.value){e[s].push(a);break}}else if(s==t.length-1){if(a.value>t[s-1]){e[s].push(a);break}}else if(a.value<=t[s]&&a.value>t[s-1]){e[s].push(a);break}ht.Default.setBatchInfo("Batch0",{color:void 0,brightness:!1,blend:!1,alphaTest:.4,transparent:!0,opacity:1,reverseFlip:!0}),ht.Default.setBatchInfo("Batch1",{color:void 0,brightness:!1,blend:!1,alphaTest:.4,transparent:!0,opacity:1,reverseFlip:!0}),ht.Default.setBatchInfo("Batch2",{color:void 0,brightness:!1,blend:!1,alphaTest:.4,transparent:!0,opacity:1,reverseFlip:!0}),ht.Default.setBatchInfo("Batch3",{color:void 0,brightness:!1,blend:!1,alphaTest:.4,transparent:!0,opacity:1,reverseFlip:!0});for(var h=0;h<e.length;h++){var u=e[h];switch(h){case 0:for(var l=0;l<u.length;l++)!function(t){var e=n.map.getConvert().getXY([u[t].lng,u[t].lat],n.centerPoint),r=new ht.Node;r.s({batch:"Batch0","all.color":i[0]}),r.setAnchorElevation(0),r.s3(300,u[t].value,300),r.p3(e.x,0,e.y),r.setScaleTall(0),n.g3d.dm().add(r),ht.Default.startAnim({duration:200,action:function(t,e){r.setScaleTall(t)}})}(l);break;case 1:for(l=0;l<u.length;l++)!function(t){var e=n.map.getConvert().getXY([u[t].lng,u[t].lat],n.centerPoint),r=new ht.Node;r.s({batch:"Batch1","all.color":i[1]}),r.setAnchorElevation(0),r.s3(300,2*u[t].value,300),r.p3(e.x,0,e.y),r.setScaleTall(0),n.g3d.dm().add(r),ht.Default.startAnim({duration:500,action:function(t,e){r.setScaleTall(t)}})}(l);break;case 2:for(l=0;l<u.length;l++)!function(t){var e=n.map.getConvert().getXY([u[t].lng,u[t].lat],n.centerPoint),r=new ht.Node;r.s({batch:"Batch2","all.color":i[2]}),r.setAnchorElevation(0),r.s3(300,3*u[t].value,300),r.p3(e.x,0,e.y),r.setScaleTall(0),n.g3d.dm().add(r),ht.Default.startAnim({duration:800,action:function(t,e){r.setScaleTall(t)}})}(l);break;case 3:for(l=0;l<u.length;l++)!function(t){var e=n.map.getConvert().getXY([u[t].lng,u[t].lat],n.centerPoint),r=new ht.Node;r.s({batch:"Batch3","all.color":i[3]}),r.setAnchor3d([.5,0,.5]),r.setAnchorElevation(0),r.s3(300,3.5*u[t].value,300),r.p3(e.x,0,e.y),r.setScaleTall(0),n.g3d.dm().add(r),ht.Default.startAnim({duration:1e3,action:function(t,e){r.setScaleTall(t)}})}(l)}}},createScatterDiagramOnMap:function(t){var e=[800,1200,2e3];t.intervalStyleArr&&3==t.intervalStyleArr.length&&(e=t.intervalStyleArr);for(var r=new Array,n=0;n<e.length;n++)r[n]=new Array;for(var i=0;i<t.posInfoArr.length;i++)for(var o=t.posInfoArr[i],a=0;a<e.length;a++)if(0==a){if(o.value<=e[a]&&0<=o.value){r[a].push(o);break}}else if(a==e.length-1){if(o.value>e[a-1]){r[a].push(o);break}}else if(o.value<=e[a]&&o.value>e[a-1]){r[a].push(o);break}for(var s=0;s<r.length;s++)(function(t,e,r,n,i,o){for(var a=[],s=0;s<t.length;s++){var h=r.getConvert().getXY([t[s].lng,t[s].lat],n);a.push(h.x,0,h.y)}var u=new ht.Points;u.setPoints(a),u.s(o),u.s("3d.movable",!1),u.s("createPointsIndex",i),u.s3(1,1,1),e.add(u)})(r[s],t.g3d.dm(),t.map,t.centerPoint,s,{"points.image":t.pointsImg[s],"points.transparent":!0,"points.size":6e3*(s+1),"points.dynamic":!0});D=t.g3d,I=t.map,C=t.centerPoint,V=r,L=t.billbordImg,E=t.isShowBillboard,document.body.addEventListener("mousemove",T)},removeSDMouseMove:function(){document.body.removeEventListener("mousemove",T)},createHeatMapOnMap:function(t){Y=new H(4096,4096);var e=new ht.Node;e.s({"top.image":Y,"all.visible":!1,"top.visible":!0}),e.s3(2e5,100,2e5),e.p3([2e4,0,-25e3]),e.setAnchorElevation(0),e.setTag("heatmapNode"),t.g3d.dm().add(e),(e=Y.getContext("2d")).clearRect(0,0,Y.width,Y.height),Q(e,t.posInfoArr,t.options,t.g3d,t.map,t.centerPoint),B=t.map,z=t.g3d,j=t.options,O=t.posInfoArr,F=t.centerPoint,R=t.zoom,t.map._map.on("zoomend",U)},removeMapZoom:function(){B&&B._map.off("zoomend",U)},createPieChart:function(t){for(var e,r=null==t.isSolid||t.isSolid,n=null!=t.opacity?t.opacity:.5,i=t.R||500,o=t.width||250,a=null==t.isPercent||t.isPercent,s=t.pieHeight||100,h=0,u=0;u<t.pieData.length;u++)!t.pieData[u].value2||h<(e=Math.max.apply(null,t.pieData[u].value2))&&(h=e);for(var l=0;l<t.pieData.length;l++){var c=t.map.getConvert().getXY([t.pieData[l].lng,t.pieData[l].lat],t.centerPoint),p=0,d=0,v=0;t.pieData[l].value.forEach(function(t){v+=t});for(var g=[c.x,0,c.y],f=0;f<t.pieData[l].value.length;f++){var y,m,x=null;p=(x=t.pieData[l].value2&&t.pieData[l].value2.length?(y=[2*i,t.pieData[l].value2[f]*s/h,2*i],d+=f==t.pieData[l].value.length-1?360-d:Math.round(t.pieData[l].value[f]/v*360),r?ot(t.g3d,p,d,t.colorArr[f],n,y,g):at(t.g3d,p,d,t.colorArr[f],n,y,g,1-o/i)):a?(m=[2*i,s,2*i],d+=f==t.pieData[l].value.length-1?360-d:Math.round(t.pieData[l].value[f]/v*360),r?ot(t.g3d,p,d,t.colorArr[f],n,m,g):at(t.g3d,p,d,t.colorArr[f],n,m,g,1-o/i)):(m=[2*i,t.pieData[l].value[f]*s/h,2*i],d+=f==t.pieData[l].value.length-1?360-d:Math.round(360/t.pieData[l].value.length),r?ot(t.g3d,p,d,t.colorArr[f],n,m,g):at(t.g3d,p,d,t.colorArr[f],n,m,g,1-o/i)),d),x.s({pieDataIndex:l,valueDataIndex:f,pieInfo:t.pieData[l]})}}K=t.g3d,$=t.map,tt=t.centerPoint,et=t.billbordImg,rt=t.pieData,nt=t.colorArr,it=t.isShowBillboard,document.body.addEventListener("mousemove",st)},removePCMouseMove:function(){document.body.removeEventListener("mousemove",st)},createLineChart:function(t,e,r,n,i){var o=[],a=[],s=[],h=void 0,u=0;if(i instanceof Object)for(var l in i){var c=Number(l);c||0===c?u++:delete i[l]}if(h=0!==u?i:{0:"rgba(145,115,205,0.5)",40:"rgba(51,153,255,0.5)",80:"rgba(93,217,174,0.5)",120:"rgba(240,225,19,0.5)",160:"rgba(242,83,75,0.5)",200:"rgba(212,0,0,0.5)"},n instanceof Array&&1<n.length)for(var p=0,d=0;d<n.length;d++){var v,g=n[d],f=g.value||0,y=void 0,m=e.getConvert().getXY([g.lng,g.lat],r),x=m.x||0,b=m.y||0;for(v in h)g.value>=v&&(y=h[v]);var w=((y=(y=(y=(y=y||"rgba(0,0,0,1)").split("(")[1]||"").split(")")[0]||"").split(","))[0]||0)/255,_=(y[1]||0)/255,M=(y[2]||0)/255,m=y[3]||1;p+=2,o.push(x||0,f||0,b||0,x||0,0,b||0),s.push(w,_,M,m,w,_,M,m),0!==d&&a.push(p-4,p-3,p-1,p-4,p-1,p-2)}var A=new ht.Node,t=t.dm();return A.s3(1,1,1),A.p3(0,0,0),A.s({shape3d:"custom","material.shader":"myShader","geometry.vs":o,"geometry.is":a,"geometry.a_color":["float32",4,s],"shape3d.transparent":!0}),t.add(A),A},createPolyline:function(s,h,u,l){var c=l.thickness||100,p=null==l.shape3dResolution?0:l.shape3dResolution,d=null==l.shape3dSide?0:l.shape3dSide,v=null!=l.shape3dReverseFlip&&l.shape3dReverseFlip,g=null!=l.shape3dTransparent&&l.shape3dTransparent,f=l.shape3dUVScale||[1,1],y=l.repeatUVLength,m=l.shape3dTopCap||"round",x=l.shape3dBottomCap||"round",t=l.lineImg||"data:image/png;base64,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";ht.Default.setImage("light",t);for(var e=0;e<l.pointInfoArr.length;e++)!function(t){var e,r,n,i,o,a=l.pointInfoArr[t];a.aimLng&&a.aimLat&&(e=h.getConvert().getXY([a.lng,a.lat],u),o=h.getConvert().getXY([a.aimLng,a.aimLat],u),r=Math.abs(e.x-o.x),t=Math.abs(e.y-o.y),t=Math.sqrt(r*r+t*t),n=new ht.Polyline,s.dm().add(n),n.setPoints([{x:e.x,y:e.y,e:0},{x:(e.x+o.x)/2,y:(e.y+o.y)/2,e:t/5},{x:o.x,y:o.y,e:0}]),n.setSegments([1,3]),n.setThickness(c),n.s({"shape.background":null,shape3d:"cylinder","shape3d.image":"light","shape3d.uv.offset":[.1,0],"shape3d.resolution":p,"shape3d.side":d,"shape3d.reverse.flip":v,"shape3d.transparent":g,"shape3d.uv.scale":f,"repeat.uv.length":y,"shape3d.top.cap":m,"shape3d.bottom.cap":x}),i=.1,o=setInterval(function(){var t=a.direction||1;i+=.01*t,n.s("shape3d.uv.offset",[i,0])},20),ut.push(o))}(e)},removeAreaLineInterval:function(){ut&&0<ut.length&&ut.forEach(function(t){clearInterval(t)})},loadTrafficFlow:function(t,e,r){e?("string"==typeof e&&(e=JSON.parse(e)),(t=new lt(t._graph3dView,t._mapOrigin,r=r||.05)).setSpeed(r),t.loadData(e)):console.warn("data can't be empty")},loadTrajectory:function(t,e){e?("string"==typeof e&&(e=JSON.parse(e)),new pt(t._graph3dView,t._mapOrigin,t._map).loadData(e)):console.warn("data can't be empty")}};ht.map=ht.mapbox=u,ht.map.plugin=ht.mapbox.plugin=t,ht.map.plugin.init=function(){ht.Default.setShader&&ht.Default.setShader("myShader","uniform mat4 uMVMatrix;\nuniform mat4 uPMatrix;\n\nattribute vec3 vs;\nattribute vec4 a_color;\n\nvarying vec4 v_color;\n\nvoid main(void) {\n    v_color = a_color;\n    gl_Position = uPMatrix * uMVMatrix * vec4(vs, 1.0);\n}\n","varying vec4 v_color;\n\nvoid main(void) {\n    gl_FragColor = v_color;\n}\n")},ht.map.plugin.init(),ht.map.getVersion=function(){return"0.2.9"}}();
